<font color="#4590a3" size = "6px">React高级实战 - 打造大众点评 WebApp</font>

<font color="#4590a3" size = "4px">王福鹏</font>

# 开始进入目录
```
cd 学习-代码-demo/react-test/react慕课网实战/React高级实战打造大众点评WebApp/大众点评-me/react-dianping-master-me/
```

# 启动目录
```
npm run build

npm run start
```

[TOC]

# 第7章 开发首页

[【React.js模仿大众点评webapp】实战教程（7）开发首页](http://www.imooc.com/article/15896)

```js
var obj = {a:10, b:20};
if (obj.c == null) {
  console.log('have');
}
```

`obj.c == null`相当于

```js
obj.c === null;
obj.c === undefined;
```

jquery.js源代码
程序中所有的等于都要用===
除了 obj.c == null 这种情况

## PureRenderMixin 性能优化
```js
import React from 'react'
import PureRenderMixin from 'react-addons-pure-render-mixin'

class NotFound extends React.Component {
    constructor(props, context) {
        super(props, context);
        this.shouldComponentUpdate = PureRenderMixin.shouldComponentUpdate.bind(this);
    }
    render() {
        return (
            <h1>404 not found page</h1>
        )
    }
}
module.exports = NotFound
```

### localStorage函数封装
app/util/localStore.js
```js
export default {
    getItem: function (key) {
        let value
        try {
            value = localStorage.getItem(key)
        } catch (ex) {
            // 开发环境下提示error
            if (__DEV__) {
                console.error('localStorage.getItem报错, ', ex.message)
            }
        } finally {
            return value
        }
    },
    setItem: function (key, value) {
        try {
            // ios safari 无痕模式下，直接使用 localStorage.setItem 会报错
            localStorage.setItem(key, value)
        } catch (ex) {
            // 开发环境下提示 error
            if (__DEV__) {
                console.error('localStorage.setItem报错, ', ex.message)
            }
        }
    }
}
```


## 存储城市到 Redux

### index.jsx
app/index.jsx
```js
import React from 'react'
import { render } from 'react-dom'
import { Provider } from 'react-redux'
import { hashHistory } from 'react-router'
import configureStore from './store/configureStore'

import './static/css/common.less'

// 创建 Redux 的 store 对象
const store = configureStore()

import RouteMap from './router/routeMap'

render(
    <Provider store={store}>
        <RouteMap history={hashHistory}/>
    </Provider>,
    document.getElementById('root')
)
```
### containers
app/containers/index.jsx
```js
import React from 'react'
import PureRenderMixin from 'react-addons-pure-render-mixin'
import LocalStore from '../util/localStore.js'
import {CITYNAME} from '../config/localStoreKey.js'
import { bindActionCreators } from 'redux'
import { connect } from 'react-redux'
import * as userInfoActionsFormOtherFile from '../actions/userinfo.js'

class App extends React.Component {
    constructor(props, context) {
        super(props, context);
        this.shouldComponentUpdate = PureRenderMixin.shouldComponentUpdate.bind(this);
        this.state = {
            initDone: false
        }
    }
    render() {
        return (
            <div>
                <h1>header</h1>
                {
                    this.state.initDone ?
                    this.props.children :
                    <div>'加载中...dd'</div>
                }
            </div>
        )
    }
    componentDidMount() {
        let cityName = LocalStore.getItem(CITYNAME);
        if (cityName == null) {
            cityName = '北京';
        }
        console.log(cityName);
        // 将城市信息存储到redux中
        this.props.userInfoActions.update({
            cityName: cityName,
        })

        this.setState(
            {initDone : true}
        )
    }
}

function mapStateToProps(state) {
  return {}
}

function mapDispatchToProps(dispatch) {
  return {
    userInfoActions: bindActionCreators(userInfoActionsFormOtherFile, dispatch)
  }
}

export default connect(
  mapStateToProps,
  mapDispatchToProps
)(App)
```

### store
app/store/configureStore.js

```js
import { createStore } from 'redux'
import rootReducer from '../reducers'

export default function configureStore(initialState) {
    const store = createStore(rootReducer, initialState,
        // 触发 redux-devtools
        window.devToolsExtension ? window.devToolsExtension() : undefined
    )
    return store
}
```
### reducers
app/reducers/index.js
```js
import { combineReducers } from 'redux'
import userinfo from './userinfo'

export default combineReducers({
    userinfo
})
```
app/reducers/userinfo.js
```js
import * as actionTypes from '../constants/userinfo'

const initialState = {}

export default function userinfo (state = initialState, action) {
    switch (action.type) {
        case actionTypes.USERINFO_UPDATE:
            return action.data
        default:
            return state
    }
}
```
### actions
app/actions/userinfo.js
```js
import * as actionTypes from '../constants/userinfo'

export function update(data) {
    return {
        type: actionTypes.USERINFO_UPDATE,
        data
    }
}
```
### constants
app/constants/userinfo.js
```js
export const USERINFO_UPDATE = 'USERINFO_UPDATE'
```
### config
app/config/localStoreKey.js
```js
export const CITYNAME = 'USER_CURRENT_CITY_NAME'
```

## HomeHeader组件

#### 选择城市-清除浮动
```css
.clearfix::after{
    content:" ";
    display:table;
    clear:both;
}
```

### css3 字体图标

- [Font Awesome](https://fontawesome.com/)
- [icomoon](https://icomoon.io/app/#/select)

#### webpack.config.js配置
```js
module: {
   loaders: [
       { test:/\.(png|gif|jpg|jpeg|bmp)$/i, loader:'url-loader?limit=5000' },  // 限制大小5kb
       { test:/\.(png|woff|woff2|svg|ttf|eot)($|\?)/i, loader:'url-loader?limit=5000'} // 限制大小小于5k
   ]
}

```

##### 公共样式及icon小图标-下载
static/css/common.less
static/css/font.css
static/fonts/...

##### css3 字体图标-导入
app/index.jsx

```js
import './static/css/common.less'
import './static/css/font.css'
```

##### css3 字体图标-使用

components/HomeHeader/index.jsx

```js
    render() {
        return (
            <div className='clear-fix'>
                <div className='float-left'>深圳</div>
                <div className='float-right'>
                <i className="icon-user"></i>
                </div>
                <div><input type="text"/></div>
            </div>
        )
    }

```

### HomeHeader组件，选择城市-input-个人中心，横屏竖屏输入框自适应宽度

components/HomeHeader/index.jsx
```js
render() {
   return (
       <div id="home-header" className="clear-fix">
           <div className="home-header-left float-left">
               <span>深圳</span>
               &nbsp;
               <i className="icon-angle-down"></i>
           </div>
           <div className="home-header-right float-right">
               <i className="icon-user"></i>
           </div>
           <div className="home-header-middle">
               <div className="search-container">
                   <i className="icon-search"></i>
                   <input type="text" placeholder="请输入关键字"/>
               </div>
           </div>
       </div>
   )
}

```

style.less
```less
#home-header {
    background-color: rgb(233, 32, 61);
    padding: 10px;

    * {
        color: #fff;
        font-size: 16px;
        line-height: 1;
    }
}
.home-header-left {
    width: 60px;
    text-align: left;
    margin: 5px 0;
}
.home-header-middle {
    width: auto;
    margin: 0 30px 0 60px;

    .search-container {
        background-color: #fff;
        border-radius: 15px;
        overflow: hidden;
        padding: 5px;

        i {
            color: #ccc !important;
        }
        input {
            font-size: 14px !important;
            font-weight: normal;
        }
    }
}
.home-header-right {
    width: 30px;
    margin: 5px 0;
    text-align: right;
}
```

### 简单轮播图

[react-swipe](https://github.com/voronianski/react-swipe)

##### swipe demo

app/components/category/index.jsx

```jsx
import React from 'react'
import PureRenderMixin from 'react-addons-pure-render-mixin'
import ReactSwipe from 'react-swipe'

import './style.less'

class Category extends React.Component {
    constructor(props, context) {
        super(props, context);
        this.shouldComponentUpdate = PureRenderMixin.shouldComponentUpdate.bind(this);
        this.state = {
            index: 0
        }
    }
    render() {
        var opt = {
          auto: 2000,
          callback: function(index) {
            this.setState({index: index})
          }.bind(this)
        }
        return (
            <div>
                <ReactSwipe className="carousel" swipeOptions={opt}>
                    <div>PANE 1</div>
                    <div>PANE 2</div>
                    <div>PANE 3</div>
                </ReactSwipe> 
                <div>
                  <ul className="myIndex">
                      <li className={this.state.index === 0 ? 'active' : ''}></li>
                      <li className={this.state.index === 1 ? 'active' : ''}></li>
                      <li className={this.state.index === 2 ? 'active' : ''}></li>
                  </ul>
                </div>
            </div>
            
        )
    }
}

// 使用 require.ensure 异步加载，还不支持 ES6 的 export 
module.exports = Category
```


```less
.myIndex {
    width: 160px;
    margin: 0 auto
}
.myIndex li {
    display: inline-block;
    list-style: none;
    width: 20px;
    height: 20px;
    margin: 10px;
    background: #999;
    border-radius: 10px
}
.myIndex li.active {
    background-color: #f90;
}
```

### 超值特惠-后端接口

#### 超值特惠-后端接口

##### npm run mock

1. 添加app同级的mock文件夹

2. package.json

```json
  "scripts": {
    "start": "NODE_ENV=dev webpack-dev-server --progress --colors",
    "mock": "node --harmony ./mock/server.js",
    "build": "rm -rf ./build && NODE_ENV=production webpack --config ./webpack.production.config.js --progress --colors"
  },
```

3. 访问 http://localhost:3000/api/homead

4. 回顾之前公用的 fetch/get.js、post.js 文件

#### 超值特惠-获取数据

新增fetch整个文件夹

./app/fetch/home/home.js

```js
export function getAdData() { const result = get('/api/homead') return result }
```

./app/containers/Home/subpage/Ad.jsx

```jsx
import React from 'react'
import PureRenderMixin from 'react-addons-pure-render-mixin'
import { getAdData } from '../../../fetch/home/home'

class Ad extends React.Component {
    constructor(props, context) {
        super(props, context);
        this.shouldComponentUpdate = PureRenderMixin.shouldComponentUpdate.bind(this);
        this.state = {
            data: []
        }
    }
    render() {
        return (
            <h1>{this.state.data.length}</h1>
        )
    }
    componentDidMount() {
      const result = getAdData();
      result.then((res) => {
        return res.json()
      }).then((json) => {
        const data = json;
        if (data.length) {
            this.setState({data: data})
        }
      })
    }
}
module.exports = Ad
```

#### 超值特惠-展示数据

数据可口： http://localhost:3000/api/homead


containers/Home/subpage/Ad.jsx

```js
import React from 'react'
import PureRenderMixin from 'react-addons-pure-render-mixin'
import { getAdData } from '../../../fetch/home/home'
import HomeAd from '../../../components/HomeAd/index'
 
class Ad extends React.Component {
    constructor(props, context) {
        super(props, context);
        this.shouldComponentUpdate = PureRenderMixin.shouldComponentUpdate.bind(this);
        this.state = {
            data: []
        }
    }
    render() {
        return (
            <div>
                {
                    this.state.data.length ?
                    <HomeAd data={this.state.data} /> :
                    <div>加载中。。。</div>
                }
            </div>
        )
    }
    componentDidMount() {
      const result = getAdData();
      result.then((res) => {
        return res.json()
      }).then((json) => {
        const data = json;
        if (data.length) {
            this.setState({data: data})
        }
      })
    }
}
module.exports = Ad
```

components/HomeAd/index.jsx

```js
import React from 'react'
import PureRenderMixin from 'react-addons-pure-render-mixin'

import './style.less'

class HomeAd extends React.Component {
    constructor(props, context) {
        super(props, context);
        this.shouldComponentUpdate = PureRenderMixin.shouldComponentUpdate.bind(this);
    }
    render() {
        return (
            <div id="home-ad">
                <h2>超值特惠</h2>
                <div className="ad-container clear-fix">
                    {this.props.data.map((item, index) => {
                        return <div key={index} className="ad-item float-left">
                            <a href={item.link} target="_blank">
                                <img src={item.img} alt={item.title}/>
                            </a>
                        </div>
                    })}
                </div>
            </div>
        )
    }
}
export default HomeAd
```


#### 猜你喜欢-后端数据

http://localhost:3000/api/homelist/%E5%8C%97%E4%BA%AC/1

#### 猜你喜欢-获取列表数据

#### 猜你喜欢-显示标题

#### 加载更多-准备数据

#### 加载更多-实现功能

containers/Home/subpage/List.jsx

```jsx
import React from 'react'
import PureRenderMixin from 'react-addons-pure-render-mixin'
import { getListData } from '../../../fetch/home/home.js'
import ListComponent from '../../../components/List/index'
import LoadMore from '../../../components/LoadMore/index'

import './style.less'

class List extends React.Component {
    constructor(props, context) {
        super(props, context);
        this.shouldComponentUpdate = PureRenderMixin.shouldComponentUpdate.bind(this);
        this.state = {
            data: [], // 存储列表信息
            hasMore: true, // 记录当前状态下，还有没有更多的数据可供加载
            isLoadingMore: false, // 记录当前状态下，是“加载中。。”还是“点击加载更多”
            page: 1 // 下一页的页码
        }
    }
    render() {
        return (
            <div>
                <h2 className='home-list-title'>猜你喜欢</h2>
                {/* 列表 */}
                {
                    this.state.data.length ?
                    <ListComponent data={this.state.data}/> :
                    <div>加载中。。。</div>
                }
                {/* loadmore */}
                {
                    this.state.hasMore ?
                    <LoadMore isLoadMore={this.state.isLoadingMore} loadMoreFn={this.loadMoreData.bind(this)}/> :
                    <div></div>
                }
                
            </div>
        )
    }
    componentDidMount() {
        // 获取首页数据
        this.loadFirstPageData()
    }
    // 获取首屏数据
    loadFirstPageData() {
      const cityName = this.props.cityName;
      const result = getListData(cityName, 0);
      this.resultHandle(result);
    }
    // 加载更多数据
    loadMoreData() {
        // 用到 this.resultHandle
        // 记录状态
        this.setState({
            isLoadingMore: true
        });
        const cityName = this.props.cityName;
        const page = this.state.page; // 下一页的页码
        const result = getListData(cityName, page);
        this.resultHandle(result);

        // 增加page的计数
        this.setState({
          page: page + 1,
          isLoadingMore: false
        })
    }
    // 数据处理
    resultHandle(result) {
      result.then(res => {
          return res.json();
      }).then(json => {
          const hasMore = json.hasMore;
          const data = json.data;

          // 存储
          this.setState({
              data: this.state.data.concat(data),
              hasMore: hasMore
            })
      })
    }
}

module.exports = List

```

components/LoadMore/index.jsx

```jsx
import React from 'react'
import PureRenderMixin from 'react-addons-pure-render-mixin'

import './style.less'

class LoadMore extends React.Component {
    constructor(props, context) {
        super(props, context);
        this.shouldComponentUpdate = PureRenderMixin.shouldComponentUpdate.bind(this);
    }
    render() {
        return (
            <div className="load-more">
              {
                  this.props.isLoadingMore ?
                  <span>加载中...</span> :
                  <span onClick={this.props.loadMoreFn}>加载更多</span>
              }
            </div>
        )
    }
}

module.exports = LoadMore

```

*点击加载更多可以在控制台Netwoork的XHR查看请求返回下一页的数据*

#### 加载更多-下拉效果

```jsx
render() {
    return (
        <div className="load-more" ref="wrapper">
            {
                this.props.isLoadingMore
                ? <span>加载中...</span>
                : <span onClick={this.loadMoreHandle.bind(this)}>点击加载更多</span>
            }
        </div>
    )
}
loadMoreHandle() {
    this.props.loadMoreFn()
}
```

ref="wrapper"，将会用到。


**实现思路是：**

监控 window 的scroll方法，然后获取ref="wrapper"的DOM，利用getBoundingClientRect()方法获得距离底部的高度，然后看是否触发 loadMore 方法。


##### 下拉加载节流
```js
componentDidMount() {
   let timeoutId;
   function callback() {
     console.log('有效')
   }
  window.addEventListener('scroll', function(){
      if (this.props.isLoadingMore) {
         return
      }
      console.log('无用');
      if (timeoutId) {
          clearTimeout(timeoutId)
      }
      timeoutId = setTimeout(callback, 50);
  }.bind(this), false)
}
```


加载更多露出来了就刷新

components/LoadMore/index.jsx
```jsx
import React from 'react'
import PureRenderMixin from 'react-addons-pure-render-mixin'

import './style.less'

class LoadMore extends React.Component {
    constructor(props, context) {
        super(props, context);
        this.shouldComponentUpdate = PureRenderMixin.shouldComponentUpdate.bind(this);
    }
    render() {
        return (
            <div className="load-more" ref="wrapper">
                {
                    this.props.isLoadingMore
                    ? <span>加载中...</span>
                    : <span onClick={this.loadMoreHandle.bind(this)}>加载更多</span>
                }
            </div>
        )
    }
    loadMoreHandle() {
        // 执行传输过来的
        this.props.loadMoreFn();
    }
    componentDidMount() {
        // 使用滚动时自动加载更多
        const loadMoreFn = this.props.loadMoreFn
        const wrapper = this.refs.wrapper
        let timeoutId
        function callback() {
            const top = wrapper.getBoundingClientRect().top
            const windowHeight = window.screen.height
            if (top && top < windowHeight) {
                // 证明 wrapper 已经被滚动到暴露在页面可视范围之内了
                loadMoreFn()
            }
        }
        window.addEventListener('scroll', function () {
            if (this.props.isLoadingMore) {
                return
            }
            if (timeoutId) {
                clearTimeout(timeoutId)
            }
            timeoutId = setTimeout(callback, 50)
        }.bind(this), false);
    }
}

export default LoadMore
```

#### 加载更多-总结

# 第8章 开发城市页面

http://www.imooc.com/article/16018

## 路由介绍

router/routeMap.jsx 中已经配置好city路径

http://localhost:8080/#/city?_k=o3jss8

containers/City/index.jsx中需要导入redux相关的

```jsx
import React from 'react'
import PureRenderMixin from 'react-addons-pure-render-mixin'
import { connect } from 'react-redux'
import { bindActionCreators } from 'redux'
import * as userInfoActionsFromOtherFile from '../../actions/userinfo'

class City extends React.Component {
    constructor(props, context) {
        super(props, context);
        this.shouldComponentUpdate = PureRenderMixin.shouldComponentUpdate.bind(this);
    }
    render() {
        return (
            <div>
                <h1>city</h1>
            </div>
        )
    }
    componentDidMount() {
        console.log(this.props.userinfo)
        console.log(this.props.userInfoActions)
    }
}

// ---------------- redux react 绑定 -------------------

function mapStateToProps(state) {
    return {
        userinfo: state.userinfo
    }
  }
  
  function mapDispatchToProps(dispatch) {
    return {
      userInfoActions: bindActionCreators(userInfoActionsFromOtherFile, dispatch)
    }
  }
  
  export default connect(
    mapStateToProps,
    mapDispatchToProps
  )(City)


```

## 跳转链接

components/HomeHeader/index.jsx

## 完成Header

components/Header/index.jsx

```jsx
import React from 'react'
import PureRenderMixin from 'react-addons-pure-render-mixin'

import './style.less'

class Header extends React.Component {
    constructor(props, context) {
        super(props, context);
        this.shouldComponentUpdate = PureRenderMixin.shouldComponentUpdate.bind(this);
    }
    render() {
        return (
            <div id="common-header">
                <span className="back-icon" onClick={this.clickHandle.bind(this)}>
                    <i className="icon-chevron-left"></i>
                </span>
                <h1>{this.props.title}</h1>
            </div>
        )
    }
    clickHandle() {
        window.history.back()
    }
}

export default Header

```

## 当前城市

## 修改城市的方法

containers/City/index.jsx

```js
import React from 'react'
import PureRenderMixin from 'react-addons-pure-render-mixin'
import { connect } from 'react-redux'
import { bindActionCreators } from 'redux'
import { hashHistory } from 'react-router'
import * as userInfoActionsFromOtherFile from '../../actions/userinfo'
import Header from '../../components/Header/index'
import CurrentCity from '../../components/CurrentCity'
import CityList from '../../components/CityList'
import LocalStore from '../../util/localStore.js'
import {CITYNAME} from '../../config/localStoreKey.js'

class City extends React.Component {
    constructor(props, context) {
        super(props, context);
        this.shouldComponentUpdate = PureRenderMixin.shouldComponentUpdate.bind(this);
    }
    render() {
        return (
            <div>
                <Header title="选择城市"/>
                <CurrentCity cityName={this.props.userinfo.cityName}/>
                <CityList changeCityFn={this.changeCity.bind(this)}/>
            </div>
        )
    }
    changeCity(newCity) {
      // 将新选择的城市设置为当前城市
      if (newCity == null) {
          return
      }
      // 1. 修改redux
      const userinfo = this.props.userinfo;
      userinfo.cityName = newCity;
      this.props.userInfoActions.update(userinfo)
      // 2. 修改localStorage
      LocalStore.setItem(CITYNAME, newCity);
      // 3. 跳转到首页
      hashHistory.push('/');
    }
    componentDidMount() {
        console.log(this.props.userinfo)
        console.log(this.props.userInfoActions)
    }
}

// ---------------- redux react 绑定 -------------------

function mapStateToProps(state) {
    return {
        userinfo: state.userinfo
    }
  }
  
  function mapDispatchToProps(dispatch) {
    return {
      userInfoActions: bindActionCreators(userInfoActionsFromOtherFile, dispatch)
    }
  }
  
  export default connect(
    mapStateToProps,
    mapDispatchToProps
  )(City)
```

components/CityList/index.jsx

```js
import React from 'react'
import PureRenderMixin from 'react-addons-pure-render-mixin'

import './style.less'

class CityList extends React.Component {
    constructor(props, context) {
        super(props, context);
        this.shouldComponentUpdate = PureRenderMixin.shouldComponentUpdate.bind(this);
    }
    render() {
        return (
            <div className="city-list-container">
                <h3>热门城市</h3>
                <ul className="clear-fix">
                    <li>
                        <span onClick={this.clickHandle.bind(this, '北京')}>北京</span>
                    </li>
                    <li>
                        <span onClick={this.clickHandle.bind(this, '上海')}>上海</span>
                    </li>
                    <li>
                        <span onClick={this.clickHandle.bind(this, '杭州')}>杭州</span>
                    </li>
                </ul>
            </div>
        )
    }
    clickHandle(newCity) {
        this.props.changeCityFn(newCity)
    }
}

export default CityList
```

# 第9章 开发搜索结果页面

http://www.imooc.com/article/16021

## 路由配置
containers/search
```jsx
componentDidMount() {
   const params = this.props.params;
   console.log('category params:', params.type);
   console.log('key params:', params.keyword)
}
```

routeMap.jsx
```js
<Router history={this.props.history}>
      <Route path='/' component={App}>
          <IndexRoute component={Home}/>
          <Route path='/city' component={City}/>
          <Route path='/User' component={User}/>
          <Route path='/search/:type(/:keyword)' component={Search}/>
          <Route path='/detail/:id' component={Detail}/>
          <Route path='*' component={NotFound}/>
      </Route>
  </Router>
```

## 约束性和非约束性组件

约束性

components/HomeHeader

```js
import React from 'react'
import PureRenderMixin from 'react-addons-pure-render-mixin'
import { Link, hashHistory } from 'react-router'

import './style.less'

class HomeHeader extends React.Component {
    constructor(props, context) {
        super(props, context);
        this.shouldComponentUpdate = PureRenderMixin.shouldComponentUpdate.bind(this);
        this.state = {
            kwd: ''
        }
    }
    render() {
        return (
            <div id="home-header" className="clear-fix">
                <div className="home-header-middle">
                    <div className="search-container">
                        <i className="icon-search"></i>
                        <input 
                        type="text" 
                        placeholder="请输入关键字"
                        onChange={this.ChangeHandle.bind(this)}
                        onKeyUp={this.KeyUpHandle.bind(this)}
                        value={this.state.kwd}/>
                    </div>
                </div>
            </div>
        )
    }
    ChangeHandle(e) {
      var val = e.target.value;
      this.setState({
          kwd: val
      })
    }
    KeyUpHandle(e) {
        if (e.keyCode !== 13) {
            return
        }
        hashHistory.push('/search/all/' + encodeURIComponent(this.state.kwd))
    }
}

module.exports = HomeHeader

```


## 抽离input
components/SearchInput

```jsx
import React from 'react'
import PureRenderMixin from 'react-addons-pure-render-mixin'

import './style.less'

class SearchInput extends React.Component {
    constructor(props, context) {
        super(props, context);
        this.shouldComponentUpdate = PureRenderMixin.shouldComponentUpdate.bind(this);
        this.state = {
          value: ''
        }
    }
    render() {
        return (
            <input 
                className='search-input'
                type="text" 
                placeholder="请输入关键字"
                onChange={this.ChangeHandle.bind(this)}
                onKeyUp={this.KeyUpHandle.bind(this)}
                value={this.state.value}/> 
        )
    }
    componentDidMount() {
        // 默认值
        this.setState({
            value: this.props.value || ''
        })
    }
    ChangeHandle(e) {
        var val = e.target.value;
        this.setState({
            value: val
        })
      }
      KeyUpHandle(e) {
          if (e.keyCode !== 13) {
              return
          }
          this.props.enterHandle(e.target.value)
      }
}

module.exports = SearchInput
```

## SearchHeader组件

## 结果列表

新增以下：
fetch/search/search.js
mock/search/list/js

配置 mock/server.js

componentDidUpdate 方法


# 第10章 开发详情页

http://www.imooc.com/article/16043

## header

conponents/List/Item 添加Link to 

新增 fetch/detail/detail.js

## 获取商户信息

新增 mock/detail/info.js
添加 mock/server.js 中 
  详情页 - 商户信息
  详情页 - 用户评论
 
containers/index.jsx  
containers/subpage/info.jsx、Comment.jsx
 
## 展示商户信息

components/DetailInfo

desc: '营业时间 11:00 - 21:00 <br> 电话订购 11:00 - 19:00 <br> 网络订购 11:00 - 19:00'

显示出 br 的方法

<p dangerouslySetInnerHTML={{__html: data.desc}}></p>


**star组件**
components/Star
```js
render() {
   let star = this.props.star || 0;
   if (star > 5) {
       star = star % 5;
   }
   return (
       <div className="star-container">
         {[1,2,3,4,5].map((item, index) => {
             const lightClass = star >= item ? ' light' : ''
             return <i key={index} className={'icon-star' + lightClass}></i>
         })}
       </div>
   )
}

```

components/DetailInfo

## 用户评论列表

http://localhost:3000/api/detail/comment/1/2

components/CommetList

containers/detail/subpage/Comment

mock/detail/comment.js

mock/server.js


# 第11章 开发登录页面

http://www.imooc.com/article/16055

## 路由配置

containers/Login
```jsx
import React from 'react'
import PureRenderMixin from 'react-addons-pure-render-mixin'

import { connect } from 'react-redux'
import { bindActionCreators } from 'redux'
import { hashHistory } from 'react-router'
import * as userInfoActionsFromOtherFile from '../../actions/userinfo' 

import Header from '../../components/Header/index'
import LoginComponent from '../../components/Login/index'

import './style.less'

class Login extends React.Component {
    constructor(props, context) {
        super(props, context);
        this.shouldComponentUpdate = PureRenderMixin.shouldComponentUpdate.bind(this);
        this.state = {
            checking: true
        }
    }
    render() {
        return (
            <div>
                <Header title="登录"/>
                {
                    this.state.checking ?
                    <div></div> :
                    <LoginComponent loginHandle={this.loginHandle.bind(this)}/>
                }
            </div>
        )
    }
    componentDidMount() {
        this.doCheck()
    }
    // 登录成功之后的业务
    loginHandle() {
      // 保存用户名
      const actions = this.props.userInfoActions;
      let userinfo = this.props.userinfo;
      actions.update(userinfo);

      // 跳转链接
      const params = this.props.params;
      const router = params.router;
      if (router) {
         // 跳转到指定的页面
         hashHistory.push(router);
      } else {
          // 条撞到默认页面，即用户中心页
          this.goUserPage()
      }
    }
    doCheck() {
        const userinfo = this.props.userinfo;
        if (userinfo.username) {
            // 已经登录
            this.goUserPage()
        } else {
            // 尚未登录
            this.setState({
                checking: false
            })
        }
    }
    goUserPage() {
        hashHistory.push('/User')
    }
}

// -------------------redux react 绑定--------------------

function mapStateToProps(state) {
    return {
        userinfo: state.userinfo
    }
}

function mapDispatchToProps(dispatch) {
    return {
        userInfoActions: bindActionCreators(userInfoActionsFromOtherFile, dispatch)
    }
}
export default connect(
    mapStateToProps,
    mapDispatchToProps
)(Login)

```

# 第12章 收藏和购买功能

## 创建子页面

http://www.imooc.com/article/16069

新增：

actions/store.js

constant/store.js

containers/detail/subpage/buy.jsx

components/BuyAndStore

## 购买功能

containers/detail/subpage/buy.jsx
```jsx
import React from 'react'
import PureRenderMixin from 'react-addons-pure-render-mixin'

import { connect } from 'react-redux'
import { bindActionCreators } from 'redux'
import { hashHistory } from 'react-router'
import * as storeActionsFromFile from '../../../actions/store'

import BuyAndStore from '../../../components/BuyAndStore/index'

import './style.less'

class Buy extends React.Component {
    constructor(props, context) {
        super(props, context);
        this.shouldComponentUpdate = PureRenderMixin.shouldComponentUpdate.bind(this);
        this.state = {
            isStore: false
        }
    }
    render() {
        return (
            <div>
                <BuyAndStore 
                isStore={this.state.isStore} 
                storeHandle={this.storeHandle.bind(this)} 
                buyHandle={this.buyHandle.bind(this)}/>
            </div>
        )
    }
    // 收藏事件
    storeHandle() {

    }
    // 购买事件
    buyHandle() {
      // 验证登录
      const loginFlag = this.loginCheck();
      if( !loginFlag) {
          return
      }
      // 购买流程

      // 跳转到用户主页
      hashHistory.push('/User')
    }
    // 验证登录
    loginCheck() {
        const id = this.props.id;
        const userinfo = this.props.userinfo;
        if (!userinfo.username) {
            // 跳转到登录页
            hashHistory.push('/Login/' + encodeURIComponent('/detail/') + id);
            return false;
        }
        return true

    }
}


function mapStateToProps(state) {
    return {
        userinfo: state.userinfo,
        store: state.store
    }
}

function mapDispatchToProps(dispatch) {
    return {
        storeActions: bindActionCreators(storeActionsFromFile, dispatch)
    }
}
export default connect(
    mapStateToProps,
    mapDispatchToProps
)(Buy)

```


## 收藏功能

reducers/store.js

actions/store.js

constant/store.js

containers/Detail/subpage/buy.jsx

```jsx
import React from 'react'
import PureRenderMixin from 'react-addons-pure-render-mixin'

import { connect } from 'react-redux'
import { bindActionCreators } from 'redux'
import { hashHistory } from 'react-router'
import * as storeActionsFromFile from '../../../actions/store'

import BuyAndStore from '../../../components/BuyAndStore/index'

import './style.less'

class Buy extends React.Component {
    constructor(props, context) {
        super(props, context);
        this.shouldComponentUpdate = PureRenderMixin.shouldComponentUpdate.bind(this);
        this.state = {
            isStore: false
        }
    }
    render() {
        return (
            <BuyAndStore isStore={this.state.isStore} buyHandle={this.buyHandle.bind(this)} storeHandle={this.storeHandle.bind(this)}/>
        )
    }
    componentDidMount() {
        this.checkStoreState();
    }
    // 验证登录
    loginCheck() {
        const id = this.props.id;
        const userinfo = this.props.userinfo;
        if (!userinfo.username) {
            // 跳转到登录页
            hashHistory.push('/Login/' + encodeURIComponent('/detail/') + id);
            return false;
        }
        return true

    }
    // 检验当前商品是否被收藏
    checkStoreState() {
        const id = this.props.id;
        const store = this.props.store;
    
        store.some(item => {
            if (item.id === id) {
                this.setState({
                    isStore: true
                })
                return true
            }
        })
    }
    // 收藏事件
    storeHandle() {
        // 验证登录
        const loginFlag = this.loginCheck();
        if( !loginFlag) {
            return
        }

        const id = this.props.id;
        const storeActions = this.props.storeActions;
        if(this.state.isStore) {
            storeActions.rm({id: id})
        } else {
            storeActions.add({id: id})
        }
        this.setState({
            isStore: !this.state.isStore
        })
    }
    // 购买事件
    buyHandle() {
      // 验证登录
      const loginFlag = this.loginCheck();
      if( !loginFlag) {
          return
      }
      // 购买流程

      // 跳转到用户主页
      hashHistory.push('/User')
    }
}


function mapStateToProps(state) {
    return {
        userinfo: state.userinfo,
        store: state.store
    }
}

function mapDispatchToProps(dispatch) {
    return {
        storeActions: bindActionCreators(storeActionsFromFile, dispatch)
    }
}
export default connect(
    mapStateToProps,
    mapDispatchToProps
)(Buy)

```

# 第13章 开发用户中心页

http://www.imooc.com/article/16075

http://localhost:3000/api/detail/info/1

## Header

### 扩展header返回按钮

components/Header

```jsx
import React from 'react'
import PureRenderMixin from 'react-addons-pure-render-mixin'
import { hashHistory } from 'react-router'

import './style.less'

class Header extends React.Component {
    constructor(props, context) {
        super(props, context);
        this.shouldComponentUpdate = PureRenderMixin.shouldComponentUpdate.bind(this);
    }
    render() {
        return (
            <div id="common-header">
                <span className="back-icon" onClick={this.clickHandle.bind(this)}>
                    <i className="icon-chevron-left"></i>
                </span>
                <h1>{this.props.title}</h1>
            </div>
        )
    }
    clickHandle() {
        const backRouter = this.props.backRouter;
        if (backRouter) {
            hashHistory.push(backRouter)
        } else {
            window.history.back()
        }
    }
}

export default Header

```

containers/User

```jsx
import React from 'react'
import PureRenderMixin from 'react-addons-pure-render-mixin'

import { connect } from 'react-redux'
import { hashHistory } from 'react-router'
import Header from '../../components/Header/index'

class User extends React.Component {
    constructor(props, context) {
        super(props, context);
        this.shouldComponentUpdate = PureRenderMixin.shouldComponentUpdate.bind(this);
    }
    render() {
        const userinfo = this.props.userinfo;
        return (
            <div>
                <Header title='用户中心' backRouter='/'/>
            </div>
        )
    }
    componentDidMount() {
        if (!this.props.userinfo.username) {
            hashHistory.push('/Login')
        }
    }
}

// -------------------redux react 绑定--------------------

function mapStateToProps(state) {
    return {
        userinfo: state.userinfo
    }
}

function mapDispatchToProps(dispatch) {
    return {
    }
}
export default connect(
    mapStateToProps,
    mapDispatchToProps
)(User)

```


## 用户信息

## 获取订单

http://localhost:3000/api/orderlist/1

fetch/user/orderlist

mock/orderlist

mock/server.js

# 第14章 评价功能 - post 提交

http://www.imooc.com/article/16080

## 评价状态

## 显示输入框

mock/orderList/orderList.js  新增 commentState

http://localhost:3000/api/orderlist/1

components/OrderList/Item

```jsx
import React from 'react'
import PureRenderMixin from 'react-addons-pure-render-mixin'

import './style.less'

class Item extends React.Component {
    constructor(props, context) {
        super(props, context);
        this.shouldComponentUpdate = PureRenderMixin.shouldComponentUpdate.bind(this);
        this.state = {
            commentState: 2 // 0-未评价 1-评价中 2-已评价
        }
    }
    render() {
        const data = this.props.data
        return (
            <div className="clear-fix order-item-container">
                <div className="order-item-img float-left">
                    <img src={data.img}/>
                </div>
                <div className="order-item-comment float-right">
                {
                    this.state.commentState === 0
                    // 未评价
                    ? <button className="btn" onClick={this.showComment.bind(this)}>评价</button>
                    :
                        this.state.commentState === 1
                        // 评价中
                        ? ''
                        // 已经评价
                        : <button className="btn unseleted-btn">已评价</button>
                }
                </div>
                <div className="order-item-content">
                    <span>商户：{data.title}</span>
                    <span>数量：{data.count}</span>
                    <span>价格：￥{data.price}</span>
                </div>
                {
                    // “评价中”才会显示输入框
                    this.state.commentState === 1
                    ? <div className="comment-text-container">
                        <textarea style={{width: '100%', height: '80px'}} className="comment-text" ref="commentText"></textarea>
                        <button className="btn" onClick={this.submitComment.bind(this)}>提交</button>
                        &nbsp;
                        <button className="btn unseleted-btn" onClick={this.hideComment.bind(this)}>取消</button>
                    </div>
                    : ''
                }
            </div>
        )
    }
    componentDidMount() {
        this.setState({
            commentState: this.props.data.commentState
        })
    }
    showComment() {
        this.setState({
            commentState: 1
        })
    }
    submitComment() {

    }
    commentOk() {
        this.setState({
            commentState: 2
        })
    }
    hideComment() {
        this.setState({
            commentState: 0
        })
    }
}

export default Item

```

## 获取评价内容

fetch/user/orderlist.js

```js
import { get } from '../get'
import { post } from '../post'

export function getOrderListData(username) {
    const result = get('/api/orderlist/' + username)
    return result
}

export function postComment(id, comment) {
    const result = post('/api/submitComment', {
        id: id,
        comment: comment
    })
    return result
}
```

containers/User/subpage/OrderList.jsx

```jsx
import React from 'react'
import PureRenderMixin from 'react-addons-pure-render-mixin'
import { getOrderListData, postComment } from '../../../fetch/user/orderlist'

import OrderListComponent from '../../../components/OrderList'

import './style.less'

class OrderList extends React.Component {
    constructor(props, context) {
        super(props, context);
        this.shouldComponentUpdate = PureRenderMixin.shouldComponentUpdate.bind(this);
        this.state = {
            data: []
        }
    }
    render() {
        return (
            <div className="order-list-container">
                <h2>您的订单</h2>
                {
                    this.state.data.length
                    ? <OrderListComponent data={this.state.data} submitComment={this.submitComment.bind(this)}/>
                    : <div>{/* loading */}</div>
                }
            </div>
        )
    }
    ...
    // 提交评价
    submitComment(id , value, callback) {
        const result = postComment(id, value)
        result.then(res => {
            return res.json()
        }).then(json => {
            if (json.errno === 0) {
                // 已经评价，修改状态
                callback()
            }
        })
    }
}

export default OrderList
```


## 提交数据



components/OrderList/Item

```jsx
import React from 'react'
import PureRenderMixin from 'react-addons-pure-render-mixin'

import './style.less'

class Item extends React.Component {
    constructor(props, context) {
        super(props, context);
        this.shouldComponentUpdate = PureRenderMixin.shouldComponentUpdate.bind(this);
        this.state = {
            commentState: 2 // 0-未评价 1-评价中 2-已评价
        }
    }
    render() {
        const data = this.props.data
        return (
            <div className="clear-fix order-item-container">
                <div className="order-item-img float-left">
                    <img src={data.img}/>
                </div>
                <div className="order-item-comment float-right">
                {
                    this.state.commentState === 0
                    // 未评价
                    ? <button className="btn" onClick={this.showComment.bind(this)}>评价</button>
                    :
                        this.state.commentState === 1
                        // 评价中
                        ? ''
                        // 已经评价
                        : <button className="btn unseleted-btn">已评价</button>
                }
                </div>
                <div className="order-item-content">
                    <span>商户：{data.title}</span>
                    <span>数量：{data.count}</span>
                    <span>价格：￥{data.price}</span>
                </div>
                {
                    // “评价中”才会显示输入框
                    this.state.commentState === 1
                    ? <div className="comment-text-container">
                        <textarea style={{width: '100%', height: '80px'}} className="comment-text" ref="commentText"></textarea>
                        <button className="btn" onClick={this.submitComment.bind(this)}>提交</button>
                        &nbsp;
                        <button className="btn unseleted-btn" onClick={this.hideComment.bind(this)}>取消</button>
                    </div>
                    : ''
                }
            </div>
        )
    }
    componentDidMount() {
        this.setState({
            commentState: this.props.data.commentState
        })
    }
    showComment() {
        this.setState({
            commentState: 1
        })
    }
    submitComment() {
        const submitComment = this.props.submitComment;
        const id = this.props.data.id;
        const commentTextDom = this.refs.commentText;
        const value = commentTextDom.value.trim();
        if (!value) {
            return
        }
        submitComment(id, value, this.commentOk.bind(this))
    }
    commentOk() {
        this.setState({
            commentState: 2
        })
    }
    hideComment() {
        this.setState({
            commentState: 0
        })
    }
}

export default Item

```

# 第15章 扩展-项目代码版本升级
npm run mock
npm 

## 补充-build错误解决方案

删除 static/css/font.css 中的

url('../fonts/icomoon.svg?6394vp#icomoon') format('svg');

webpack.pro.cof.js 中删除 SVG 、 immutable

## webpack3 升级npm组件

升级 webpack3

- `npm uninstall babel-loader css-loader extract-text-webpack-plugin file-loader webpack webpack-dev-server --save-dev` 然后重新安装（可使用淘宝镜像`--registry=https://registry.npm.taobao.org`）
- 修改 `webpack.config.js` 和 `webpack.production.config.js`
- 增加 `postcss.config.js`
- package.json 
    - `"start": "NODE_ENV=dev webpack-dev-server --hot --open"`
    - `"build": "rm -rf ./build && NODE_ENV=production webpack -p --progress --config webpack.production.config.js"`
- app/components/Category/style.less 修改背景图片
- b/app/components/HomeAd/index.jsx 修改图片
- b/app/components/List/Item/index.jsx 修改图片

webpack3 升级配置文件

webpack3 升级打包命令

**本地图片路径**
```js
let img = require('../../static/img/2.png')

render(){
    img src={img}
}
```
## 升级 React-router 4

- `npm uninstall react-router react-router-dom --save` 然后重新安装（可使用淘宝镜像`--registry=https://registry.npm.taobao.org`）
- 删除`app/router/routeMap.jsx`，增加`app/router/AppRouter.jsx` 和 `app/router/SubRouter.jsx`
- `react-router` 替换为 `react-router-dom`
- 所有的 `hashHistory.push` 改为 `this.props.history.push(backRouter)` ，并且把 `import { hashHistory } from 'react-router'` 删除
- app/containers/City/index.jsx 将 `hashHistory.push` 修改为 `this.props.history.replace`
- 增加 `withRouter`
    - 所有 router 配置的，带`connect`的组件
    - `container/index.jsx`
- 将所有 `this.props.params` 修改为 `this.props.match.params`
- `<Header` `<HomeHeader` `<SearchHeader` 的引用增加 `history={this.props.history}`


index.jsx中import AppRouter from './router/AppRouter'



