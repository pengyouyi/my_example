<font color="#4590a3" size = "6px">音乐APP</font>

<font color="#4590a3" size = "6px">黄轶</font>

[TOC]

# 源码获取
发送邮件到 280309453@qq.com
邮件标题：申请开通音乐APP代码权限
邮件内容：github、慕课网订单号

[https://github.com/ustbhuangyi/vue-music](https://github.com/ustbhuangyi/vue-music)

# vue-cli
初始化目录
```
vue init webpack vue-music
```
启动目录
```
cd vue-music
cnpm install
npm run dev
```
安装依赖插件
```
cnpm install stylus --save-dev
cnpm install stylus-loader --save-dev
```
 添加eslintrc.js
 ```
   'rules': {
    // 默认配置always，要求在行末加上分号。
    'semi': ['error','always'],
    // 统一代码缩进方式，默认值是4 spaces.
    'indent': 0,
    // 函数定义时，function关键字后面的小括号前是否需要加空格
    'space-before-function-paren': 0,
    // //该规则规定文件最后强制换行，仅需留一空行
    'eol-last': 0
  }

 ```
[更多eslint配置](http://www.cnblogs.com/allin123/p/5754500.html)

路径配置别名
webpack.base.conf.js
```
resolve: {
    extensions: ['.js', '.vue', '.json'],
    alias: {
      'vue$': 'vue/dist/vue.esm.js',
      '@': resolve('src'),
      // 新增
      'common': resolve('src/common')
    }
  },

```

安装依赖插件
```
cnpm install babel-runtime --save
cnpm install fastclick --save
cnpm install babel-ployfill --save-dev
```
[babel-runtime](https://www.npmjs.com/package/babel-runtime)

[让浏览器支持es6语法](https://zhidao.baidu.com/question/245118649193949164.html)

fastclick 解决移动端300毫秒延迟问题

# 页面入口+header组件的编写

在main.js中引入
```
import Vue from 'vue'
import 'babel-polyfill'
import fastclick from 'fastclick'

fastclick.attach(document.body)
```

## stylus @import "~common/" 
stylus中引入@import "~common/stylus/variable"，为何要加上~

[解答](http://coding.imooc.com/learn/questiondetail/12639.html)

# 推荐页面

## 直接获取浏览器json数据
[QQ音乐](https://m.y.qq.com/)
Network => XHR => fcg_yqq...

### jsonp原理+Promise封装

[jsonp原理](https://github.com/webmodules/jsonp)

### 抓取线上数据
[QQ音乐线上jsonp](https://c.y.qq.com/musichall/fcgi-bin/fcg_yqqhomepagerecommend.fcg)

首先安装jsonp
```
npm install jsonp --save
```

common/js/jsonp.js
```
import originJSONP from 'jsonp';

export default function jsonp(url, data, option) {
    url += (url.indexOf('?') < 0 ? '?' : '&') + param(data);
    return new Promise((resolve, reject) => {
      originJSONP(url, option, (err, data) => {
          if (!err) {
              resolve(data);
          } else {
              reject(err);
          }
      });
    });
}

function param(data) {
    let url = '';
    for (var k in data) {
        let value = data[k] !== undefined ? data[k] : '';
        url += `&${k}=${encodeURIComponent(value)}`;
    }
    return url ? url.substring(1) : '';
}
```

api/config.js
```
export const commonParams = {
  g_tk: 5381,
  inCharset: 'utf-8',
  outCharset: 'utf-8',
  notice: 0,
  format: 'jsonp'
};

export const options = {
  param: 'jsonpCallback'
};

export const ERR_OK = 0;
```
api/recommend.js
```
import jsonp from 'common/js/jsonp';
import {commonParams, options} from './config';

export function getRecommend() {
    const url = 'https://c.y.qq.com/musichall/fcgi-bin/fcg_yqqhomepagerecommend.fcg';
    const data = Object.assign({}, commonParams, {
        platform: 'h5',
        uin: 0,
        needNewCode: 1
    });
    return jsonp(url, data, options);
}
```

在recommend.vue中使用
```
<script type="text/ecmascript-6">
import {getRecommend} from 'api/recommend';
import {ERR_OK} from 'api/config';
export default {
  created() {
    this._getRecommend();
  },
  methods: {
    _getRecommend() {
      getRecommend().then((res) => {
        if (res.code === ERR_OK) {
          console.log(res.data);
        }
      });
    }
  }
};
</script>
```

## 轮播图组件

安装better-scroll
```
npm inatall better-scroll --save-dev
```

### mounted 和 created

slider.vue组件mounted中计算轮播宽度时，recommend中Created还没获取到数据，所以计算不到，该怎么解决

给recommend.vue的slider组件外层包裹容器加上v-if
```
<div v-if="recommends.length" class="slider-wrapper">
```

slider.vue
```
<div class="slider" ref="slider">
    <div class="slider-group" ref="sliderGroup">
      <slot>
      </slot>
    </div>
    <div class="dots">
     
    </div>
</div>

mounted () {
   setTimeout(function() {
       this._setSliderWidth();
       this._initSlider();
   }, 20);
},
```

recommend.vue
```
<div v-if="recommends.length" class="slider-wrapper">
   <slider>
     <div v-for="item in recommends">
       <a :href="item.linkUrl">
         <img :src="item.picUrl" alt="">
       </a>
     </div>
   </slider>
 </div>
```
```
export default {
  data() {
      return {
          recommends: []
      };
  },
  created() {
    this._getRecommend();
  },
  components: {
    Slider
  },
  methods: {
    _getRecommend() {
      getRecommend().then((res) => {
        if (res.code === ERR_OK) {
          // console.log(res.data);
          this.recommends = res.data.slider;
        }
      });
    }
  }
};
```
### 完整轮播组件
slider.vue
```
<template>
  <div class="slider" ref="slider">
    <div class="slider-group" ref="sliderGroup">
      <slot>
      </slot>
    </div>
    <div class="dots">
      <span class="dot" v-for="(item,index) in dots" :class="{'active': currentPageIndex === index}"></span>
    </div>
  </div>
</template>

<script type="text/ecmascript-6">
import BScroll from 'better-scroll';
import {addClass} from 'common/js/dom';
export default {
    props: {
        loop: {
            type: Boolean,
            default: true
        },
        autoPlay: {
            type: Boolean,
            default: true
        },
        interval: {
            type: Number,
            default: 4000
        }
    },
    data() {
        return {
            dots: [],
            currentPageIndex: 0
        };
    },
    mounted() {
        setTimeout(() => {
            this._setSliderWidth();
            this._initDots();
            this._initSlider();
            if (this.autoPlay) {
                this._play();
            }
        }, 20);
        window.addEventListener('resize', () => {
            if (!this.slider) {
                return;
            }
            this._setSliderWidth(true);
            this.slider.refresh();
        });
    },
    methods: {
        _setSliderWidth(isResize) {
          this.children = this.$refs.sliderGroup.children;
          let width = 0;
          let sliderWidth = this.$refs.slider.clientWidth;
          for (let i = 0; i < this.children.length; i++) {
              let child = this.children[i];
              addClass(child, 'slider-item');
              child.style.width = sliderWidth + 'px';
              width += sliderWidth;
          }
          if (this.loop && !isResize) {
            width += 2 * sliderWidth;
          }
          this.$refs.sliderGroup.style.width = width + 'px';
        },
        _initSlider() {
          this.slider = new BScroll(this.$refs.slider, {
              scrollX: true,
              scrollY: false,
              // momentum: true 当快速滑动时是否开启滑动惯性
              momentum: false,
              // snap: false 该属性是给 slider 组件使用的，普通的列表滚动不需要配置
              snap: true,
              // snapLoop: false 是否可以无缝循环轮播
              snapLoop: this.loop,
              // snapThreshold: 0.1 用手指滑动时页面可切换的阈值，大于这个阈值可以滑动的下一页
              snapThreshold: 0.3,
              // snapSpeed: 400, 轮播图切换的动画时间
              snapSpeed: 200
          });
          this.slider.on('scrollEnd', () => {
            let pageIndex = this.slider.getCurrentPage().pageX;
            if (this.loop) {
                pageIndex -= 1;
            }
            this.currentPageIndex = pageIndex;
            if (this.autoPlay) {
                clearTimeout(this.timer);
                this._play();
            }
          });
        },
        _initDots() {
            this.dots = new Array(this.children.length);
        },
        _play() {
            let pageIndex = this.currentPageIndex + 1;
            if (this.loop) {
                pageIndex += 1;
            }
            this.timer = setTimeout(() => {
              this.slider.goToPage(pageIndex, 0, 400);
            }, this.interval);
        }
    }
};
</script>

<style lang="stylus" rel="stylesheet/stylus">
  @import "~common/stylus/variable"

  .slider
    min-height: 1px
    position relative
    .slider-group
      position: relative
      overflow: hidden
      white-space: nowrap
      .slider-item
        float: left
        box-sizing: border-box
        overflow: hidden
        text-align: center
        a
          display: block
          width: 100%
          overflow: hidden
          text-decoration: none
        img
          display: block
          width: 100%
    .dots
      position: absolute
      right: 0
      left: 0
      bottom: 12px
      text-align: center
      font-size: 0
      .dot
        display: inline-block
        margin: 0 4px
        width: 8px
        height: 8px
        border-radius: 50%
        background: $color-text-l
        &.active
          width: 20px
          border-radius: 5px
          background: $color-text-ll
</style>
```
dom.js
```
export function addClass(el, className) {
  if (hasClass(el, className)) {
      return;
  }
  let newClass = el.className.split(' ');
  newClass.push(className);
  el.className = newClass.join(' ');
};

export function hasClass(el, className) {
    let reg = new RegExp('(^|\\s)' + className + '(\\s|$)');
    return reg.test(el.className);
}
```
recommend.vue调用slider组件
```
<template>
  <div>
    <div class="recommend">
      <div v-if="recommends.length" class="slider-wrapper">
        <slider>
          <div v-for="item in recommends">
            <a :href="item.linkUrl">
              <img :src="item.picUrl" alt="">
            </a>
          </div>
        </slider>
      </div>
      <div class="recommend-list">
        <h1 class="list-title">热门歌单推荐</h1>
        <ul>

        </ul>
      </div>
    </div>
  </div>
</template>

<script type="text/ecmascript-6">
import Slider from 'base/slider/slider';
import {getRecommend} from 'api/recommend';
import {ERR_OK} from 'api/config';
export default {
  data() {
      return {
          recommends: []
      };
  },
  created() {
    this._getRecommend();
  },
  components: {
    Slider
  },
  methods: {
    _getRecommend() {
      getRecommend().then((res) => {
        if (res.code === ERR_OK) {
          // console.log(res.data);
          this.recommends = res.data.slider;
        }
      });
    }
  }
};
</script>
<style lang="stylus" rel="stylesheet/stylus">
  @import "~common/stylus/variable"
  .recommend
    position: fixed
    width: 100%
    top: 88px
    bottom: 0
    .recommend-content
      height: 100%
      overflow: hidden
      .slider-wrapper
        position: relative
        width: 100%
        overflow: hidden
</style>
```
注意A链接是不用给它派发click: true
因为派发click：true会阻止浏览器默认点击事件，而fastclick又阻止了派发的click:true

优化轮播图组件
1.添加keep-alive
app.vue
```
<Tab></Tab>
<keep-alive>
  <router-view></router-view>
</keep-alive>
```
2.在Vue中的slider组件生命周期
```
destroyed() {
   clearTimeout(this.timer);
},
```


## 歌单数据接口分析

[QQ音乐分类歌单](https://y.qq.com/portal/playlist.html)

[分类歌单JSON数据](https://c.y.qq.com/splcloud/fcgi-bin/fcg_get_diss_by_tag.fcg)

此时在浏览器无法预览歌单数据，且JSONP也无法读取URL，

报错误码500-内部服务器错误

前端无法绕过Headers中的host、referer
```
access-control-allow-origin:http://y.qq.com
referer:https://y.qq.com/portal/playlist.html
```

### axios 介绍和后端接口代理

[axios](https://github.com/mzabriskie/axios)

安装axios
```
npm install axios --save
```

dev-server.js新增
```
var axios = require('axios')

var apiRoutes = express.Router()

apiRoutes.get('/getDiscList', function (req, res) {
  var url = 'https://c.y.qq.com/splcloud/fcgi-bin/fcg_get_diss_by_tag.fcg'
  axios.get(url, {
    headers: {
      referer: 'https://c.y.qq.com/',
      host: 'c.y.qq.com'
    },
    params: req.query
  }).then((response) => {
    res.json(response.data)
  }).catch((e) => {
    console.log(e)
  })
})

app.use('/api', apiRoutes)
```
recommend.js
```
export function getDiscList() {
  const url = '/api/getDiscList';

  const data = Object.assign({}, commonParams, {
    platform: 'yqq',
    hostUin: 0,
    sin: 0,
    ein: 29,
    sortId: 5,
    needNewCode: 0,
    categoryId: 10000000,
    rnd: Math.random(),
    format: 'json'
  });

  return axios.get(url, {
    params: data
  }).then((res) => {
    return Promise.resolve(res.data);
  });
}
```
recommend.vue
```
<script type="text/ecmascript-6">
import {getRecommend, getDiscList} from 'api/recommend';
import {ERR_OK} from 'api/config';
export default {
  data() {
      return {
          recommends: []
      };
  },
  created() {
    this._getDiscList();
  },
  methods: {
    _getDiscList() {
        getDiscList().then((res) => {
          if (res.code === ERR_OK) {
             console.log(res.data);
          }
        });
      }
  }
};
</script>
```

浏览器可访问抓取的[getDiscList](http://localhost:8080/api/getDiscList?g_tk=5381&inCharset=utf-8&outCharset=utf-8&notice=0&format=json&platform=yqq&hostUin=0&sin=0&ein=29&sortId=5&needNewCode=0&categoryId=10000000&rnd=0.732565425766549)

## better-scroll 如何使用及错误原因

better-scroll 使用注意事项
1.书写结构，ref下有一个包含整个内容的div或者ul
```
<template>
  <div class="wrapper" ref="wrapper">
    <ul class="content">
      <li>...</li>
      <li>...</li>
      ...
    </ul>
  </div>
</template>
```
2.需要在DOM渲染完成后去new BScroll,也即
this.$nextTick 或者 setTimeout(fn, 20) 调用
```
<script>
  import BScroll from 'better-scroll'
  export default {
    mounted() {
      this.$nextTick(() => {
        this.scroll = new Bscroll(this.$refs.wrapper, {})
      })
    }
  }
</script>
```
```
<script>
  import BScroll from 'better-scroll'
  export default {
    mounted() {
      setTimeout(() => {
         this._initScroll();
      }, 20);
    },
    methods: {
      _initScroll() {
	      if (!this.scroll) {
	        this.scroll = new BScroll(this.$refs.wrapper, {});
	      } else {
	        this.scroll.refresh();
	      }
	    }
    }
  }
</script>
```
3.当有异步请求的数据是，需要在获取data数据之后再new BScroll
```
<template>
  <div class="wrapper" ref="wrapper">
    <ul class="content">
      <li v-for="item in data">{{item}}</li>
    </ul>
  </div>
</template>
<script>
  import BScroll from 'better-scroll'
  export default {
    data() {
      return {
        data: []
      }
    },
    created() {
      requestData().then((res) => {
        this.data = res.data
        this.$nextTick(() => {
          this.scroll = new Bscroll(this.$refs.wrapper, {})
        })
      })
    }
  }
</script>
```
better-scroll 初始化后不能滚动的原因
1.内层Content的高度需要大于外层wrapper的高度
```
<div class="wrapper">
  <ul class="content">
    <li>...</li>
    <li>...</li>
    ...
  </ul>
</div>
```
```
.wrapper
  height 400px
  overflow hidden
  ul
   li
     line-height 30px
     text-align center
```

[更多better-scroll](https://github.com/DDFE/DDFE-blog/issues/15)

### better-scroll组件的抽象和使用 

scroll.vue
```
<template>
  <div ref="wrapper">
    <slot></slot>
  </div>
</template>

<script type="text/ecmascript-6">
import BScroll from 'better-scroll';
export default {
  props: {
      // probeType: 1 会截流,只有在滚动结束的时候派发一个 scroll 事件。
      probeType: {
          type: Number,
          default: 1
      },
      click: {
          type: Boolean,
          default: true
      },
      data: {
          type: Array,
          default: null
      }
  },
  mounted() {
      setTimeout(() => {
          this._initScroll();
      }, 20);
  },
  methods: {
      _initScroll() {
        if (!this.$refs.wrapper) {
            return;
        }
        this.scroll = new BScroll(this.$refs.wrapper, {
            probeType: this.probeType,
            click: this.click
        });
      },
      enable() {
          this.scroll && this.scroll.enable();
      },
      disable() {
          this.scroll && this.scroll.disable();
      },
      refresh() {
          this.scroll && this.scroll.refresh();
      }
  },
  watch: {
      data() {
        setTimeout(() => {
            this.refresh();
        }, 20);
      }
  }
};
</script>

<style lang="stylus" rel="stylesheet/stylus">

</style>
```
在recommend.vue中使用
```
<template>
  <div class="recommend">
    <Scroll ref="scroll" class="recommend-content" :data="discList">
      <div>
        <div v-if="recommends.length" class="slider-wrapper"></div>
        <div class="recommend-list"></div>
      </div>
    </Scroll>
  </div>
</template>

<script type="text/ecmascript-6">
import Scroll from 'base/scroll/scroll';
export default {
  data() {
      return {
          discList: []
      };
  },
  created() {
    this._getDiscList();
  },

  components: {
    Scroll
  },
  methods: {
    _getDiscList() {
      getDiscList().then((res) => {
        if (res.code === ERR_OK) {
          //  console.log(res.data);
          this.discList = res.data.list;
        }
      });
    }
  }

};
</script>
```
```
  .recommend
    position: fixed
    width: 100%
    top: 88px
    bottom: 0
    .recommend-content
      height: 100%
      overflow: hidden
      .slider-wrapper
        position: relative
        width: 100%
        overflow: hidden
      .recommend-list

```
### better-scroll组件优化
以上例子中滚动的内容包含两部分，一个是slider另一个是歌单list，如果slider延迟1s获取数据，那么better-scroll 是不会把slider 的高度计算进去，从而better-scroll 得出的高度比较小，不能滚到底部，该怎么解决？

给slider组件中的图片添加load事件，调用scroll组件的refresh方法

recommend.vue核心代码
```
<slider>
  <img :src="item.picUrl" alt="" @load="loadImage">
</slider>

methods: {
	loadImage() {
	 if (!this.checkLoaded) {
	   this.$refs.scroll.refresh();
	   this.checkLoaded = true;
	 }
	}
}
```

recommend.vue完整代码
```
<template>
  <div class="recommend">
    <Scroll ref="scroll" class="recommend-content" :data="discList">
      <div>
        <div v-if="recommends.length" class="slider-wrapper">
          <slider>
            <div v-for="item in recommends">
              <a :href="item.linkUrl">
                <img :src="item.picUrl" alt="" @load="loadImage">
              </a>
            </div>
          </slider>
        </div>
        <div class="recommend-list">
          <h1 class="list-title">热门歌单推荐</h1>
          <ul>
            <li v-for="item in discList" class="item">
              <div class="icon">
                <img :src="item.imgurl" width="60" height="60" alt="">
              </div>
              <div class="text">
                <h2 class="name" v-html="item.creator.name"></h2>
                <p class="desc" v-html="item.dissname"></p>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </Scroll>
  </div>
</template>

<script type="text/ecmascript-6">
import Slider from 'base/slider/slider';
import {getRecommend, getDiscList} from 'api/recommend';
import {ERR_OK} from 'api/config';
import Scroll from 'base/scroll/scroll';
export default {
  data() {
      return {
          recommends: [],
          discList: []
      };
  },
  created() {
    this._getRecommend();
    this._getDiscList();
  },
  components: {
    Slider,
    Scroll
  },
  methods: {
    _getRecommend() {
      getRecommend().then((res) => {
        if (res.code === ERR_OK) {
          // console.log(res.data);
          this.recommends = res.data.slider;
        }
      });
    },
    _getDiscList() {
      getDiscList().then((res) => {
        if (res.code === ERR_OK) {
          //  console.log(res.data);
          this.discList = res.data.list;
        }
      });
    },
    loadImage() {
      if (!this.checkLoaded) {
        this.$refs.scroll.refresh();
        this.checkLoaded = true;
      }
    }
  }
};
</script>
<style scoped lang="stylus" rel="stylesheet/stylus">
@import "~common/stylus/variable"

  .recommend
    position: fixed
    width: 100%
    top: 88px
    bottom: 0
    .recommend-content
      height: 100%
      overflow: hidden
      .slider-wrapper
        position: relative
        width: 100%
        overflow: hidden
      .recommend-list
        .list-title
          height: 65px
          line-height: 65px
          text-align: center
          font-size: $font-size-medium
          color: $color-theme
        .item
          display: flex
          box-sizing: border-box
          align-items: center
          padding: 0 20px 20px 20px
          .icon
            flex: 0 0 60px
            width: 60px
            padding-right: 20px
          .text
            display: flex
            flex-direction: column
            justify-content: center
            flex: 1
            line-height: 20px
            overflow: hidden
            font-size: $font-size-medium
            .name
              margin-bottom: 10px
              color: $color-text
            .desc
              color: $color-text-d
</style>
```
## Vue-lazyload 懒加载插件的介绍和应用

[github vue-lazyload](https://github.com/hilongjw/vue-lazyload)

首先安装
```
cnpm install vue-lazyload --save
```
main.js 全局引入
```
import VueLazyload from 'vue-lazyload';

Vue.use(VueLazyload, {
  loading: require('common/image/default.png')
});
```
在recommend.vue中使用
```
<img :src="item.imgurl" width="60" height="60" alt="">
```
将`:src`替换为`v-lazy`
```
<img v-lazy="item.imgurl" width="60" height="60" alt="">
```

全局scroll时将click设为true导致slider不能点击，解决方法

给img添加needsclick样式,防止被fastclick阻止
```
<a :href="item.linkUrl">
  <img class="needsclick" :src="item.picUrl" alt="" @load="loadImage">
</a>

```
## loading 基础组件的开发和应用
loading.vue
```
<template>
  <div class="loading">
    <img width="24" height="24" src="./loading.gif">
    <p class="desc">{{title}}</p>
  </div>
</template>
<script type="text/ecmascript-6">
  export default {
    props: {
      title: {
        type: String,
        default: '正在载入...'
      }
    }
  };
</script>
<style scoped lang="stylus" rel="stylesheet/stylus">
  @import "~common/stylus/variable"

  .loading
    width: 100%
    text-align: center
    .desc
      line-height: 20px
      font-size: $font-size-small
      color: $color-text-l
</style>
```

recommend.vue使用
```
<template>
  <div class="recommend">
    <Scroll ref="scroll" class="recommend-content" :data="discList">
      <div></div>
      <div class="loading-container" v-show="!discList.length">
        <loading></loading>
      </div>
    </Scroll>
  </div>
</template>

import Loading from 'base/loading/loading';

  components: {
    Loading
  },

```

# 歌手页面

## 歌手页数据获取
[歌手页面](https://y.qq.com/portal/singer_list.html)

[歌手页面JSON数据](https://c.y.qq.com/v8/fcg-bin/v8.fcg?channel=singer&page=list&key=all_all_all&pagesize=100&pagenum=1&g_tk=5381&jsonpCallback=GetSingerListCallback&loginUin=2390803922&hostUin=0&format=jsonp&inCharset=utf8&outCharset=utf-8&notice=0&platform=yqq&needNewCode=0)

### 歌手数据接口抓取

注意url中的查询参数需要拼接对才能正确获取返回数据

data里的字段要完全

```
export function getSingerList() {
    const url = 'https://c.y.qq.com/v8/fcg-bin/v8.fcg';
    const data = Object.assign({}, commonParams, {
        channel: 'singer',
        page: 'list',
        key: 'all_all_all',
        pagesize: 100,
        pagenum: 1,
        hostUin: 0,
        platform: 'yqq',
        needNewCode: 0
    });
    return jsonp(url, data, options);
}
```

### 歌手数据处理和Singer类的封装

singer原始的数据结构[data.list](https://c.y.qq.com/v8/fcg-bin/v8.fcg?channel=singer&page=list&key=all_all_all&pagesize=100&pagenum=1&g_tk=5381&jsonpCallback=GetSingerListCallback&loginUin=2390803922&hostUin=0&format=jsonp&inCharset=utf8&outCharset=utf-8&notice=0&platform=yqq&needNewCode=0)

原始数据结构
```
GetSingerListCallback(
{
		code: 0,
     -data: {
        -list: [
		   {
				Farea: "1",
				Fattribute_3: "3",
				Fattribute_4: "0",
				Fgenre: "0",
				Findex: "X",
				Fother_name: "Joker",
				Fsinger_id: "5062",
				Fsinger_mid: "002J4UUk29y8BY",
				Fsinger_name: "薛之谦",
				Fsinger_tag: "541,555",
				Fsort: "1",
				Ftrend: "0",
				Ftype: "0",
				voc: "0"
		   },
		   {   },
		   {   }
		   ...
```
想得到的新数据结构
```
newList: [
   {
     title: "热门"
     items: {
		  Fsinger_mid: "002J4UUk29y8BY",
		  Fsinger_name: "薛之谦",
		  avatar: XXX
     }
   },
   {
     title: "A"
     items: {
		  Fsinger_mid: "002J4UUk29y8BY",
		  Fsinger_name: "薛之谦",
		  avatar: XXX
     }
   },
   {
     title: "Z"
     items: {
		  Fsinger_mid: "002J4UUk29y8BY",
		  Fsinger_name: "薛之谦",
		  avatar: XXX
     }
   },
```

使用_normalizeSinger方法处理获得的list

singer.vue
```
<script type="text/ecmascript-6">
import BScroll from 'better-scroll';
import {getSingerList} from 'api/singer';
import {ERR_OK} from 'api/config';
import Singer from 'common/js/singer';
const HOT_NAME = '热门';
const HOT_SINGER_LEN = 10;

export default {
  data() {
      return {
          singers: []
      };
  },
  created() {
    this._getSingerList();
  },
  methods: {
    _getSingerList() {
      getSingerList().then((res) => {
        if (res.code === ERR_OK) {
          this.singers = res.data.list;
          console.log(this._normalizeSinger(this.singers));
          this.$nextTick(() => {
            this._initScroll();
          });
        }
      });
    },
    _normalizeSinger(list) {
      let map = {
        hot: {
          title: HOT_NAME,
          items: []
        }
      };
      list.forEach((item, index) => {
        if (index < HOT_SINGER_LEN) {
          map.hot.items.push(
            new Singer({
              id: item.Fsinger_mid,
              name: item.Fsinger_name
            })
          );
        }
        const key = item.Findex;
        if (!map[key]) {
          map[key] = {
            title: key,
            items: []
          };
        }
        map[key].items.push(
          new Singer({
            id: item.Fsinger_mid,
            name: item.Fsinger_name
          })
        );
      });
      let hot = [];
      let ret = [];
      for (let key in map) {
        let val = map[key];
        if (val.title.match(/[a-zA-Z]/)) {
          ret.push(val);
        } else if (val.title === HOT_NAME) {
          hot.push(val);
        }
      }
      ret.sort((a, b) => {
        return a.title.charCodeAt(0) - b.title.charCodeAt(0);
      });
      return hot.concat(ret);
    },
    _initScroll() {
      if (!this.scroll) {
        this.scroll = new BScroll(this.$refs.wrapper, {});
      } else {
        this.scroll.refresh();
      }
    }
  }
};
</script>
```
singer.js
```
export default class Singer {
  constructor({id, name}) {
    this.id = id;
    this.name = name;
    this.avatar = `https://y.gtimg.cn/music/photo_new/T001R300x300M000${id}.jpg?max_age=2592000`;
  }
}
```

左右联动实现的主要思路
主内容滚动的时候需要知道它的实时位置，
根据实时位置计算落在哪个区间，
通过区间知道索引

### 字母和歌手联动
listview.vue
```
<template>
  <scroll class="listview" 
  :data="data" 
  ref="listview" 
  :listenScroll="listenScroll" 
  :probeType="probeType"
  @scroll="scroll">
    <ul>
        <li v-for="group in data" class="list-group" ref="listGroup">
          <h2 class="list-group-title">{{group.title}}</h2>
          <ul>
              <li v-for="item in group.items" class="list-group-item">
                  <img v-lazy="item.avatar" class="avatar" alt="">
                  <span class="name">{{item.name}}</span>
              </li>
          </ul>
        </li>
    </ul>
    <div class="list-shortcut" @touchstart="onShortcutTouchStart" @touchmove.stop.prevent="onShortcutTouchMove">
        <ul>
            <li v-for="(item,index) in shortcutList" class="item" :data-index="index" :class="{'current':currentIndex===index}">{{item}}</li>
        </ul>
    </div>
    <div class="list-fixed" v-show="fixedTitle" ref="fixed">
        <h1 class="fixed-title">{{fixedTitle}}</h1>
    </div>
    <div v-show="!data.length" class="loading-container">
      <loading></loading>
    </div>
  </scroll>
</template>

<script type="text/ecmascript-6">
import Scroll from 'base/scroll/scroll';
import {getData} from 'common/js/dom.js';
import Loading from 'base/loading/loading';

const ANCHOR_HEIGHT = 18;
const TITLE_HEIGHT = 30;

export default {
  props: {
      data: {
          type: Array,
          default: []
      }
  },
  computed: {
    shortcutList() {
        return this.data.map((group) => {
            return group.title.substring(0, 1);
        });
    },
    fixedTitle() {
        if (this.scrollY > 0) {
            return '';
        }
        return this.data[this.currentIndex] ? this.data[this.currentIndex].title : '';
    }
  },
  data() {
      return {
          scrollY: -1,
          currentIndex: 0,
          diff: -1
      };
  },
  components: {
    Scroll,
    Loading
  },
  created() {
    this.touch = {};
    this.listenScroll = true;
    this.listHeight = [];
    this.probeType = 3;
  },
  watch: {
    data() {
        setTimeout(() => {
          this._calculateHeight();
        }, 20);
    },
    scrollY(newY) {
        const listHeight = this.listHeight;
        // 当滚动到顶部，newYY>0
        if (newY > 0) {
            this.currentIndex = 0;
            return;
        }
        // 当滚动到中间部分
        for (let i = 0; i < listHeight.length - 1; i++) {
            let height1 = listHeight[i];
            let height2 = listHeight[i + 1];
            if (-newY >= height1 && -newY < height2) {
                this.currentIndex = i;
                this.diff = height2 + newY;
                return;
            }
        }
        // 当滚动到底部，且-newY大于最后一个元素的上线限
        this.currentIndex = listHeight.length - 2;
    },
    diff(newVal) {
      let fixedTop = (newVal > 0 && newVal < TITLE_HEIGHT) ? newVal - TITLE_HEIGHT : 0;
      if (this.fixedTop === fixedTop) {
          return;
      }
      this.fixedTop = fixedTop;
      this.$refs.fixed.style.transform = `translate3d(0,${fixedTop}px,0)`;
    }
  },
  methods: {
    onShortcutTouchStart(e) {
      let anchorIndex = getData(e.target, 'index');
      let firstTouch = e.touches[0];
      this.touch.y1 = firstTouch.pageY;
      this.touch.anchorIndex = anchorIndex;
      this._scrollTo(anchorIndex);
    },
    onShortcutTouchMove(e) {
        let firstTouch = e.touches[0];
        this.touch.y2 = firstTouch.pageY;
        // x | 0 向下取整，相当于 Math.floor(x)
        let delta = (this.touch.y2 - this.touch.y1) / ANCHOR_HEIGHT | 0;
        let anchorIndex = parseInt(this.touch.anchorIndex) + delta;
        this._scrollTo(anchorIndex);
    },
    _scrollTo(index) {
      if (!index && index !== 0) {
          return;
      }
      if (index < 0) {
          index = 0;
      } else if (index > this.listHeight - 2) {
          index = this.listHeight - 2;
      }
      this.scrollY = -this.listHeight[index];
      this.$refs.listview.scrollToElement(this.$refs.listGroup[index], 0);
    },
    scroll(pos) {
      this.scrollY = pos.y;
    },
    _calculateHeight() {
      this.listHeight = [];
      let height = 0;
      this.listHeight.push(height);
      this.$refs.listGroup.forEach((item, index) => {
          height += item.clientHeight;
          this.listHeight.push(height);
      });
    }
  }
};
</script>
```

# 歌手详情
二级路由
http://localhost:8080/singer/

http://localhost:8080/singer/002J4UUk29y8BY

index.js
```
import SingerDetail from 'components/singer-detail/singer-detail';

Vue.use(Router);

export default new Router({
  mode: 'history',
  routes: [
    {
      path: '/singer',
      name: 'Singer',
      component: Singer,
      children: [
        {
          path: ':id',
          component: SingerDetail
        }
      ]
    },
  ]
});
```
singer.vue
```
<template>
  <div class="singer">
    <list-view :data="singers" @select="selectSinger"></list-view>
    <router-view></router-view>
  </div>
</template>

methods: {
    selectSinger(singer) {
      this.$router.push({
        path: `/singer/${singer.id}`
      });
    },
}
```

要跳转到的singer-detail.vue
```
<template>
<transition name="slide">
  <div class="singer-detail">
      歌手详情
  </div>
</transition>
</template>
```

## Vuex初始化
- store
  - index.js
  - actions.js
  - getters.js
  - mutations.js
  - mutation-types.js
  - state.js
  
- main.js 引入store
- 业务层
  - singer.vue需要跳转及传递给XX的页
  - singer-detail.js跳转到的及接收数据的页面
  
  
store/ index.js
```
import Vue from 'vue';
import Vuex from 'vuex';
import * as actions from './actions';
import * as getters from './getters';
import state from './state';
import mutations from './mutations';
import createLogger from 'vuex/dist/logger';

Vue.use(Vuex);

const debug = process.env.NODE_ENV !== 'production';

export default new Vuex.Store({
    actions,
    getters,
    state,
    mutations,
    strict: debug,
    plugins: debug ? [createLogger()] : []
});
```
store/state.js
```
const state = {
    singer: {}
};

export default state;
```
store/mutations.js
```
import * as types from './mutation-types';

const mutations = {
    [types.SET_SINGER](state, singer) {
        state.singer = singer;
    }
};

export default mutations;
```

store/mutation-types.js
```
export const SET_SINGER = 'SET_SINGER';
```

store/getters.js
```
export const singer = state => state.singer;
```

main.js
```
import Vue from 'vue';
import 'babel-polyfill';
import App from './App';
import router from './router';
import fastclick from 'fastclick';
import VueLazyload from 'vue-lazyload';
import store from './store/index';

fastclick.attach(document.body);

import './common/stylus/index.styl';

Vue.config.productionTip = false;
Vue.use(VueLazyload, {
  loading: require('common/image/default.png')
});

/* eslint-disable no-new */
new Vue({
  el: '#app',
  router,
  store,
  template: '<App/>',
  components: { App },
  render: h => h(App)
});
```
singer.js
```
<template>
  <div class="singer">
    <list-view :data="singers" @select="selectSinger"></list-view>
    <router-view></router-view>
  </div>
</template>
<script type="text/ecmascript-6">
import {mapMutations} from 'vuex';

export default {
  data() {
      return {
          singers: []
      };
  },
  methods: {
    selectSinger(singer) {
      this.$router.push({
        path: `/singer/${singer.id}`
      });
      this.setSinger(singer);
    },
    ...mapMutations({
      setSinger: 'SET_SINGER'
    })
  }
};
</script>
```
singer-detail.js
```
<template>
<transition name="slide">
  <div class="singer-detail">
      详情
  </div>
</transition>
</template>

<script type="text/ecmascript-6">
import {mapGetters} from 'vuex';
export default {
  computed: {
    ...mapGetters([
      'singer'
    ])
  },
  created() {
    console.log(this.singer);
  }
};
</script>
```

[vuex更多](https://vuex.vuejs.org/zh-cn/structure.html)

music-list 歌手背景图片放大，列表上推动画
```
<template>
  <div class="music-list">
    <div class="back" >
      <i class="icon-back"></i>
    </div>
    <h1 class="title" v-html="title"></h1>
    <div class="bg-image" :style="bgStyle" ref="bgImage">
      <div class="filter" ref="filter"></div>
    </div>
    <div class="bg-layer" ref="layer"></div>
    <scroll @scroll="scroll" :probe-type="probeType" :listen-scroll="listenScroll" :data="songs" class="list" ref="list">
        <div class="song-list-wrapper">
            <song-list :songs="songs"></song-list>
        </div>
    </scroll>
  </div>
</template>

<script type="text/ecmascript-6">
import Scroll from 'base/scroll/scroll';
import SongList from 'base/song-list/song-list';
const RESERVED_HEIGHT = 40;
export default {
  props: {
      bgImage: {
          type: String,
          default: ''
      },
      songs: {
          type: Array,
          default: []
      },
      title: {
          type: String,
          default: ''
      }
  },
  components: {
    Scroll,
    SongList
  },
  computed: {
      bgStyle() {
          return `background-image: url(${this.bgImage})`;
      }
  },
  mounted() {
      this.imageHeight = this.$refs.bgImage.clientHeight;
      this.minTranslateY = -this.imageHeight + RESERVED_HEIGHT;
      this.$refs.list.$el.style.top = `${this.$refs.bgImage.clientHeight}px`;
  },
  created() {
      this.probeType = 3;
      this.listenScroll = true;
  },
  data() {
      return {
          scrollY: 0
      };
  },
  methods: {
      scroll(pos) {
        this.scrollY = pos.y;
      }
  },
  watch: {
      scrollY(newY) {
          let translateY = Math.max(this.minTranslateY, newY);
          let zIndex = 0;
          let scale = 1;
          let blur = 0;
          this.$refs.layer.style['transform'] = `translate3d(0, ${translateY}px, 0)`;
          this.$refs.layer.style['webkitTransform'] = `translate3d(0, ${translateY}px, 0)`;
          const percent = Math.abs(newY / this.imageHeight);
          if (newY > 0) {
              scale = 1 + percent;
              zIndex = 10;
          } else {
              blur = Math.min(20 * percent, 20);
          }
          this.$refs.filter.style['backdrop-filter'] = `blur(${blur}px)`;
          this.$refs.filter.style['webkitBackdrop-filter'] = `blur(${blur}px)`;
          if (newY < this.minTranslateY) {
              zIndex = 10;
              this.$refs.bgImage.style.paddingTop = 0;
              this.$refs.bgImage.style.height = `${RESERVED_HEIGHT}px`;
          } else {
              this.$refs.bgImage.style.paddingTop = '70%';
              this.$refs.bgImage.style.height = 0;
          }
          this.$refs.bgImage.style.zIndex = zIndex;
          this.$refs.bgImage.style['transform'] = `scale${scale})`;
          this.$refs.bgImage.style['webkitTransform'] = `scale(${scale})`;
      }
  }
};
</script>
```

# 播放器内置组件开发

[create-keyframe-animation](https://github.com/HenrikJoreteg/create-keyframe-animation)

## 小球放大缩小例子
```
<template>
  <div class="player" v-show="playlist.length>0">
    <transition name="normal"
            @enter="enter"
            @after-enter="afterEnter"
            @leave="leave"
            @after-leave="afterLeave"
    >
      <div class="normal-player" v-show="fullScreen">
        <div class="background">
          <img width="100%" height="100%" :src="currentSong.image">
        </div>
        <div class="top">
          <div class="back" @click="back">
            <i class="icon-back"></i>
          </div>
          <h1 class="title" v-html="currentSong.name"></h1>
          <h2 class="subtitle" v-html="currentSong.singer"></h2>
        </div>
        <div class="middle"
        >
          <div class="middle-l" ref="middleL">
            <div class="cd-wrapper" ref="cdWrapper">
              <div class="cd">
                  <img class="image" :src="currentSong.image">
              </div>
            </div>
            <div class="playing-lyric-wrapper">
              <div class="playing-lyric"></div>
            </div>
          </div>
        </div>
        <div class="bottom">
          <div class="dot-wrapper">
            <span class="dot"></span>
            <span class="dot"></span>
          </div>
          <div class="progress-wrapper">
            <span class="time time-l"></span>
            <div class="progress-bar-wrapper">
            </div>
            <span class="time time-r"></span>
          </div>
          <div class="operators">
            <div class="icon i-left">
                <i class="icon-sequence"></i>
            </div>
            <div class="icon i-left">
              <i class="icon-prev"></i>
            </div>
            <div class="icon i-center">
                <i class="icon-pause"></i>
            </div>
            <div class="icon i-right">
              <i class="icon-next"></i>
            </div>
            <div class="icon i-right">
              <i class="icon icon-not-favorite"></i>
            </div>
          </div>
        </div>
      </div>
    </transition>
    <transition name="mini"></transition>
      <div class="mini-player" v-show="!fullScreen" @click="open">
        <div class="icon">
          <img width="40" height="40" :src="currentSong.image">
        </div>
        <div class="text">
          <h2 class="name" v-html="currentSong.name"></h2>
          <p class="desc" v-html="currentSong.singer"></p>
        </div>
        <div class="control">
        </div>
        <div class="control">
          <i class="icon-playlist"></i>
        </div>
      </div>

  </div>
</template>

<script type="text/ecmascript-6">
import {mapGetters, mapMutations} from 'vuex';
import animations from 'create-keyframe-animation';
import {prefixStyle} from 'common/js/dom';
const transform = prefixStyle('transform');
export default {
    computed: {
        ...mapGetters([
            'fullScreen',
            'playlist',
            'currentSong'
        ])
    },
    methods: {
        back() {
            this.setFullScreen(false);
        },
        open() {
            this.setFullScreen(true);
        },
        ...mapMutations({
            setFullScreen: 'SET_FULL_SCREEN'
        }),
        enter(el, done) {
            const {x, y, scale} = this._getPosAndScale();

            let animation = {
            0: {
                transform: `translate3d(${x}px,${y}px,0) scale(${scale})`
            },
            60: {
                transform: `translate3d(0,0,0) scale(1.1)`
            },
            100: {
                transform: `translate3d(0,0,0) scale(1)`
            }
            };

            animations.registerAnimation({
            name: 'move',
            animation,
            presets: {
                duration: 400,
                easing: 'linear'
              }
            });

            animations.runAnimation(this.$refs.cdWrapper, 'move', done);
        },
        afterEnter() {
            animations.unregisterAnimation('move');
            this.$refs.cdWrapper.style.animation = '';
        },
        leave(el, done) {
            this.$refs.cdWrapper.style.transition = 'all 0.4s';
            const {x, y, scale} = this._getPosAndScale();
            this.$refs.cdWrapper.style[transform] = `translate3d(${x}px,${y}px,0) scale(${scale})`;
            this.$refs.cdWrapper.addEventListener('transitionend', done);
        },
        afterLeave() {
            this.$refs.cdWrapper.style.transition = '';
            this.$refs.cdWrapper.style[transform] = '';
        },
        _getPosAndScale() {
            // 小圆的宽度
            const targetWidth = 40;
            // 小圆中心离左侧的距离
            const paddingLeft = 40;
            // 小圆中心离底边的距离
            const paddingBottom = 30;
            // 大圆上侧距离屏幕顶端
            const paddingTop = 80;
            // 大圆宽度
            const width = window.innerWidth * 0.8;
            // 小圆/大圆
            const scale = targetWidth / width;
            // 小圆球心到大圆球心的x位移
            const x = -(window.innerWidth / 2 - paddingLeft);
            // 小圆球心到大圆球心的y位移
            const y = window.innerHeight - paddingTop - width / 2 - paddingBottom;
            return {
                x,
                y,
                scale
            };
        }
    }
};
</script>
```

## 进度条可点击、滑动
progress-bar.vue
```
<template>
  <div class="progress-bar" ref="progressBar" @click="progressClick">
      <div class="bar-inner">
          <div class="progress" ref="progress"></div>
          <div class="progress-btn-wrapper" 
               ref="progressBtn"
               @touchstart.prevent = "progressTouchStart"  
               @touchmove.prevent = "progressTouchMove"
               @touchend = "progressTouchEnd"
          >
              <div class="progress-btn"></div>
          </div>
      </div>
  </div>
</template>

<script type="text/ecmascript-6">
import {prefixStyle} from 'common/js/dom';
const progressBtnWidth = 16;
const transform = prefixStyle('transform');
export default {
    props: {
        percent: {
            type: Number,
            default: 0
        }
    },
    watch: {
        percent(newPercent) {
          if (newPercent >= 0 && !this.touch.initiated) {
            const barWidth = this.$refs.progressBar.clientWidth - progressBtnWidth;
            const offsetWidth = newPercent * barWidth;
            this._offset(offsetWidth);
          }
        }
    },
    created() {
      this.touch = {};
    },
    methods: {
        progressTouchStart(e) {
            this.touch.initiated = true;
            this.touch.startX = e.touches[0].pageX;
            this.touch.left = this.$refs.progress.clientWidth;
        },
        progressTouchMove(e) {
            if (!this.touch.initiated) {
                return;
            }
            const deltaX = e.touches[0].pageX - this.touch.startX;
            const barWidth = this.$refs.progressBar.clientWidth - progressBtnWidth;
            const offsetWidth = Math.min(barWidth, Math.max(0, this.touch.left + deltaX));
            this._offset(offsetWidth);
        },
        progressTouchEnd() {
            this.touch.initiated = false;
            this._triggerPercent();
        },
        progressClick(e) {
          this._offset(e.offsetX);
          this._triggerPercent();
        },
        _triggerPercent() {
          const barWidth = this.$refs.progressBar.clientWidth - progressBtnWidth;
          const percent = this.$refs.progress.clientWidth / barWidth;
          this.$emit('percentChange', percent);
        },
        _offset(offsetWidth) {
            this.$refs.progress.style.width = `${offsetWidth}px`;
            this.$refs.progressBtn.style[transform] = `translate3d(${offsetWidth}px, 0, 0)`;
        }
    }
};
</script>

<style scoped lang="stylus" rel="stylesheet/stylus">
  @import "~common/stylus/variable"

  .progress-bar
    height: 30px
    .bar-inner
      position: relative
      top: 13px
      height: 4px
      background: rgba(0, 0, 0, 0.3)
      .progress
        position: absolute
        height: 100%
        background: $color-theme
      .progress-btn-wrapper
        position: absolute
        left: -8px
        top: -13px
        width: 30px
        height: 30px
        .progress-btn
          position: relative
          top: 7px
          left: 7px
          box-sizing: border-box
          width: 16px
          height: 16px
          border: 3px solid $color-text
          border-radius: 50%
          background: $color-theme
</style>
```

player.vue
```
<div class="progress-wrapper">
  <span class="time time-l">{{format(currentTime)}}</span>
  <div class="progress-bar-wrapper">
    <ProgressBar @percentChange="onProgressChange" :percent="percent"></ProgressBar>
  </div>
  <span class="time time-r">{{format(currentSong.duration)}}</span>
</div>
export default {
    computed: {
        percent() {
          return this.currentTime / this.currentSong.duration;
        },
		}
	 methods: {
        onProgressChange(percent) {
          this.$refs.audio.currentTime = percent * this.currentSong.duration;
          if (!this.playing) {
            this.togglePlaying();
          }
        }
}
```
## 圆形进度条实现
```
<circle class="progress-bar" r="50" cx="50" cy="50" fill="transparent" stroke-dasharray="314" stroke-dashoffset="157"></circle>
```
根据circle的stroke-dasharray和stroke-dashoffset两个属性形成的

cx="圆的x轴坐标"
cy="圆的y轴坐标"
r="圆的半径". 必需.
fill="圆的填充背景色"
stroke-dasharray="314"  画虚线，一个参数5代表，则表示会先画5px实线，紧接着是5px空白，然后又是5px实线，从而形成虚线。
stroke-dashoffset 定义虚线开始的位置

[更多svg stroke属性](https://segmentfault.com/a/1190000007309718)

progress-bar.vue
```
<template>
  <div class="progress-circle">
      <svg :width="radius" :height="radius" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg">
          <circle class="progress-background" r="50" cx="50" cy="50" fill="transparent"></circle>
          <circle class="progress-bar" r="50" cx="50" cy="50" fill="transparent" 
          :stroke-dasharray="dashArray" 
          :stroke-dashoffset="dashOffset"></circle>
      </svg>
      <slot></slot>
  </div>
</template>

<script type="text/ecmascript-6">
export default {
    props: {
        radius: {
            type: Number,
            default: 100
        },
        percent: {
            type: Number,
            default: 0
        }
    },
    data() {
        return {
            dashArray: Math.PI * 100
        };
    },
    computed: {
        dashOffset() {
            return (1 - this.percent) * this.dashArray;
        }
    }
};
</script>

<style scoped lang="stylus" rel="stylesheet/stylus">
  @import "~common/stylus/variable"

  .progress-circle
    position: relative
    circle
      stroke-width: 8px
      transform-origin: center
      &.progress-background
        transform: scale(0.9)
        stroke: $color-theme-d
      &.progress-bar
        transform: scale(0.9) rotate(-90deg)
        stroke: $color-theme
</style>
```

## 播放模式切换功能-顺序、单曲循环、随机

player.vue
```
<div class="icon i-left" @click="changeMode">
  <i :class="iconMode"></i>
</div>

computed: {
        playIcon() {
          return this.playing ? 'icon-pause' : 'icon-play';
        },
        iconMode() {
          return this.mode === playMode.sequence ? 'icon-sequence' : this.mode === playMode.loop ? 'icon-loop' : 'icon-random';
        },
        percent() {
          return this.currentTime / this.currentSong.duration;
        },
        ...mapGetters([
            'fullScreen',
            'playlist',
            'currentSong',
            'playing',
            'currentIndex',
            'mode',
            'sequenceList'
        ])
    },
methods: {
    ...mapMutations({
            setFullScreen: 'SET_FULL_SCREEN',
            setPlayingState: 'SET_PLAYING_STATE',
            setCurrentIndex: 'SET_CURRENT_INDEX',
            setPlayMode: 'SET_PLAY_MODE',
            setPlayList: 'SET_PLAYLIST'
        }),

     end() {
          if (this.mode === playMode.loop) {
            this.loop();
          } else {
            this.next();
          }
        },
        loop() {
          this.$refs.audio.currentTime = 0;
          this.$refs.audio.play();
        },
        next() {
          if (!this.songReady) {
            return;
          }
          let index = this.currentIndex + 1;
          if (index === this.playlist.length) {
            index = 0;
          }
          this.setCurrentIndex(index);
          if (!this.playing) {
            this.togglePlaying();
          }
          this.songReady = false;
        },

    changeMode() {
          const mode = (this.mode + 1) % 3;
          this.setPlayMode(mode);
          let list = null;
          if (mode === playMode.random) {
            list = shuffle(this.sequenceList);
          } else {
            list = this.sequenceList;
          }
          this.resetCurrentIndex(list);
          this.setPlayList(list);
        },
        resetCurrentIndex(list) {
          let index = list.findIndex((item) => {
            return item.id === this.currentSong.id;
          });
          this.setCurrentIndex(index);
        }
    },
```
actions.js
```
import * as types from './mutation-types';
import {playMode} from 'common/js/config';
import {shuffle} from 'common/js/util';

export const selectPlay = function({commit, state}, {list, index}) {
    commit(types.SET_SEQUENCE_LIST, list);
    if (state.mode === playMode.random) {
        let randomList = shuffle(list);
        commit(types.SET_PLAYLIST, randomList);
        index = findIndex(randomList, list[index]);
    } else {
        commit(types.SET_PLAYLIST, list);
    }
    commit(types.SET_CURRENT_INDEX, index);
    commit(types.SET_FULL_SCREEN, true);
    commit(types.SET_PLAYING_STATE, true);
};

export const randomPlay = function({commit}, {list}) {
  commit(types.SET_PLAY_MODE, playMode.random);
  commit(types.SET_SEQUENCE_LIST, list);
  let randomList = shuffle(list);
  commit(types.SET_PLAYLIST, randomList);
  commit(types.SET_CURRENT_INDEX, 0);
    commit(types.SET_FULL_SCREEN, true);
    commit(types.SET_PLAYING_STATE, true);
};

function findIndex(list, song) {
    return list.findIndex((item) => {
        return item.id === song.id;
    });
}
```

## 随机播放全部
music-list.vue
```
<template>
  <div class="music-list">
        <div class="play-wrapper">
            <div class="play" v-show="songs.length > 0" ref="playBtn" @click="random">
                <i class="icon-play"></i>
                <span class="text">随机播放全部</span>
            </div>
        </div>
  </div>
</template>

<script type="text/ecmascript-6">
import {mapActions} from 'vuex';

export default {
  props: {
      songs: {
          type: Array,
          default: []
      }
  },
  methods: {
      selectItem(item, index) {
          this.selectPlay({
              list: this.songs,
              index: index
          });
      },
      random() {
        this.randomPlay({list: this.songs});
      },
      ...mapActions([
          'selectPlay',
          'randomPlay'
      ])
  },
```
## 播放器歌词数据抓取
[https://y.qq.com/portal/player.html](https://y.qq.com/portal/player.html)页面

[https://c.y.qq.com/lyric/fcgi-bin/fcg_query_lyric_new.fcg](https://c.y.qq.com/lyric/fcgi-bin/fcg_query_lyric_new.fcg?callback=MusicJsonCallback_lrc&pcachetime=1499866619609&songmid=003v4UL61IYlTY&g_tk=5381&jsonpCallback=MusicJsonCallback_lrc&loginUin=2390803922&hostUin=0&format=jsonp&inCharset=utf8&outCharset=utf-8&notice=0&platform=yqq&needNewCode=0).js

api/song.js
```
import {commonParams} from './config';
import axios from 'axios';

export function getLyric(mid) {
  const url = '/api/lyric';

  const data = Object.assign({}, commonParams, {
    songmid: mid,
    platform: 'yqq',
    hostUin: 0,
    needNewCode: 0,
    categoryId: 10000000,
    pcachetime: +new Date(),
    format: 'json'
  });

  return axios.get(url, {
    params: data
  }).then((res) => {
    return Promise.resolve(res.data);
  });
}
```
dev-server.js新增
```
apiRoutes.get('/lyric', function (req, res) {
  var url = 'https://c.y.qq.com/lyric/fcgi-bin/fcg_query_lyric_new.fcg'
  axios.get(url, {
    headers: {
      referer: 'https://c.y.qq.com/',
      host: 'c.y.qq.com'
    },
    params: req.query
  }).then((response) => {
    var ret = response.data
    if (typeof ret === 'string') {
      var reg = /^\w+\(({[^()]+})\)$/
      var matches = ret.match(reg)
      if (matches) {
        ret = JSON.parse(matches[1])
      }
    }
    res.json(ret)
  }).catch((e) => {
    console.log(e)
  })
})
```
common/js/song.js
```
import {getLyric} from 'api/song';
import {ERR_OK} from 'api/config';

export default class Song {
  constructor({id, mid, singer, name, album, duration, image, url}) {
    this.id = id;
    this.mid = mid;
    this.singer = singer;
    this.name = name;
    this.album = album;
    this.duration = duration;
    this.image = image;
    this.url = url;
  }
  getLyric() {
    getLyric(this.mid).then((res) => {
      if (res.retcode === ERR_OK) {
        this.lyric = res.lyric;
        console.log(this.lyric);
      }
    });
  }
};
```
player.vue
```
watch: {
      currentSong(newSong, oldSong) {
        if (newSong.id === oldSong.id) {
          return;
        }
        this.$nextTick(() => {
          this.$refs.audio.play();
          this.currentSong.getLyric();
        });
      },

```

## 歌词解码
### [js-base64](https://github.com/dankogai/js-base64)

安装
```
$ npm install --save js-base64
```
使用
```
import {Base64} from 'js-base64';
Base64.decode(res.lyric);
```
### [lyric-parser](https://github.com/ustbhuangyi/lyric-parser)

安装
```
$ npm install --save lyric-parser
```
使用
```
import Lyric from 'lyric-parser'
let lyric = new Lyric(lyricStr, handler)

function hanlder({lineNum, txt}){
   // this hanlder called when lineNum change
}

```
修改common/js/song.js
```
import {Base64} from 'js-base64';

export default class Song {
  constructor({id, mid, singer, name, album, duration, image, url}) {
    this.id = id;
    this.mid = mid;
    this.singer = singer;
    this.name = name;
    this.album = album;
    this.duration = duration;
    this.image = image;
    this.url = url;
  }
  getLyric() {
    if (this.lyric) {
      return Promise.resolve(this.lyric);
    }
    return new Promise((resolve, reject) => {
      getLyric(this.mid).then((res) => {
        if (res.retcode === ERR_OK) {
          this.lyric = Base64.decode(res.lyric);
          resolve(this.lyric);
          <!--console.log(this.lyric);-->
        } else {
          reject('no lyric');
        }
      });
    });
  }
};
```
player.vue
```
import Lyric from 'lyric-parser';
data() {
      return {
        currentLyric: null
      };
    },
    
methods: {    
    getLyric() {
          this.currentSong.getLyric().then((lyric) => {
            this.currentLyric = new Lyric(lyric);
            console.log(this.currentLyric);
          });
        },
    }
watch: {
        this.$nextTick(() => {
          this.$refs.audio.play();
          this.getLyric();
        });
      },
}

```

展现出的是一个Lyric对象

### 播放器歌词滚动列表实现

player.vue
```
<scroll class="middle-r" ref="lyricList" :data="currentLyric && currentLyric.lines">
  <div class="lyric-wrapper">
    <div v-if="currentLyric">
      <p class="text"
         :class="{'current': currentLyricNum === index}"
         ref="lyricLine"
         v-for="(line,index) in currentLyric.lines"
      >
      {{line.txt}}
      </p>
    </div>
  </div>
</scroll>

data() {
      return {
        currentLyric: null,
        currentLyricNum: 0
      };
    },
}
methods: {
  getLyric() {
     this.currentSong.getLyric().then((lyric) => {
       this.currentLyric = new Lyric(lyric, this.handleLyric);
       if (this.playing) {
         this.currentLyric.play();
       }
       // console.log(this.currentLyric);
     });
   },
   handleLyric({lineNum, txt}) {
     this.currentLyricNum = lineNum;
     if (lineNum > 5) {
       let lineEl = this.$refs.lyricLine[lineNum - 5];
       this.$refs.lyricList.scrollToElement(lineEl, 1000);
     } else {
       this.$refs.lyricList.scrollTo(0, 0, 1000);
     }
   },
}
```

## 播放器歌词左右滑动实现
player.vue
```
<div class="middle"
             @touchstart.prevent="midleTouchStart"
             @touchmove.prevent="midleTouchMove"
             @touchend="midleTouchEnd"
        >
          <div class="middle-l" ref="middleL">
            <div class="cd-wrapper" ref="cdWrapper">
              <div class="cd" :class="cdCls">
                  <img class="image" :src="currentSong.image">
              </div>
            </div>
            <!--<div class="playing-lyric-wrapper">
              <div class="playing-lyric"></div>
            </div>-->
          </div>
          <scroll class="middle-r" ref="lyricList" :data="currentLyric && currentLyric.lines">
            <div class="lyric-wrapper">
              <div v-if="currentLyric">
                <p class="text"
                   :class="{'current': currentLyricNum === index}"
                   ref="lyricLine"
                   v-for="(line,index) in currentLyric.lines"
                >
                {{line.txt}}
                </p>
              </div>
            </div>
          </scroll>
        </div>
        <div class="bottom">
          <div class="dot-wrapper">
            <span class="dot" :class="{'active': currentShow==='cd'}"></span>
            <span class="dot" :class="{'active': currentShow==='lyric'}"></span>
          </div>


import {prefixStyle} from 'common/js/dom';
const transform = prefixStyle('transform');
const transitionDuration = prefixStyle('transitionDuration');

methods: {
    midleTouchStart(e) {
          this.touch.initiated = true;
          const touch = e.touches[0];
          this.touch.startX = touch.pageX;
          this.touch.startY = touch.pageY;
        },
        midleTouchMove(e) {
          if (!this.touch.initiated) {
            return;
          }
          const touch = e.touches[0];
          const deltaX = touch.pageX - this.touch.startX;
          const deltaY = touch.pageY - this.touch.startY;
          if (Math.abs(deltaY) > Math.abs(deltaX)) {
            return;
          }
          const left = this.currentShow === 'cd' ? 0 : -window.innerWidth;
          const offsetWidth = Math.min(0, Math.max(-window.innerWidth, left + deltaX));
          this.touch.percent = Math.abs(offsetWidth / window.innerWidth);
          this.$refs.lyricList.$el.style[transform] = `translate3d(${offsetWidth}px, 0, 0)`;
          this.$refs.lyricList.$el.style[transitionDuration] = 0;
          this.$refs.middleL.style.opacity = 1 - this.touch.percent;
          this.$refs.middleL.style[transitionDuration] = 0;
        },
        midleTouchEnd() {
          let offsetWidth;
          let opacity;
          if (this.currentShow === 'cd') {
            if (this.touch.percent > 0.1) {
              offsetWidth = -window.innerWidth;
              opacity = 0;
              this.currentShow = 'lyric';
            } else {
              offsetWidth = 0;
              opacity = 1;
            }
          } else {
            if (this.touch.percent < 0.9) {
              offsetWidth = 0;
              this.currentShow = 'cd';
              opacity = 1;
            } else {
              offsetWidth = -window.innerWidth;
              opacity = 0;
            }
          }
          const time = 300;
          this.$refs.lyricList.$el.style[transform] = `translate3d(${offsetWidth}px, 0, 0)`;
          this.$refs.lyricList.$el.style[transitionDuration] = `${time}ms`;
          this.$refs.middleL.style.opacity = opacity;
          this.$refs.middleL.style[transitionDuration] = `${time}ms`;
      },
}
```
## 播放器剩余功能的实现

### 滑动进度条歌词滚动到相应的位置
```
onProgressChange(percent) {
     const currentTime = percent * this.currentSong.duration;
     this.$refs.audio.currentTime = currentTime;
     if (!this.playing) {
       this.togglePlaying();
     }
     if (this.currentLyric) {
       this.currentLyric.seek(currentTime * 1000);
     }
   },
```
### 单曲循环结束时再开始歌词滚到开始位置
```
loop() {
     this.$refs.audio.currentTime = 0;
     this.$refs.audio.play();
     if (this.currentLyric) {
       this.currentLyric.seek(0);
     }
   },

```
### 暂停播放的时候歌词也暂停
```
togglePlaying() {
          if (!this.songReady) {
            return;
          }
          this.setPlayingState(!this.playing);
          if (this.currentLyric) {
            this.currentLyric.togglePlay();
          }
        },
```
### 切换到下一首歌时上一首歌的歌词来回跳动
```
 watch: {
      currentSong(newSong, oldSong) {
        if (newSong.id === oldSong.id) {
          return;
        }
        if (this.currentLyric) {
          this.currentLyric.stop();
        }
        this.$nextTick(() => {
          this.$refs.audio.play();
          this.getLyric();
        });
      },
```
### 播放页少量歌词
```
<div class="playing-lyric-wrapper">
    <div class="playing-lyric">{{playingLyric}}</div>
</div>

handleLyric({lineNum, txt}) {
     this.currentLyricNum = lineNum;
     if (lineNum > 5) {
       let lineEl = this.$refs.lyricLine[lineNum - 5];
       this.$refs.lyricList.scrollToElement(lineEl, 1000);
     } else {
       this.$refs.lyricList.scrollTo(0, 0, 1000);
     }
     this.playingLyric = txt;
   },

```
### 异步获取歌词失效
```
getLyric() {
     this.currentSong.getLyric().then((lyric) => {
       this.currentLyric = new Lyric(lyric, this.handleLyric);
       if (this.playing) {
         this.currentLyric.play();
       }
       // console.log(this.currentLyric);
     }).catch(() => {
       this.currentLyric = null;
       this.playingLyric = '';
       this.currentLineNum = 0;
     });
   },

```
### 播放器底部播放器适配+mixin的应用

common/js/mixin.js
```
import {mapGetters} from 'vuex';
export const playlistMixin = {
    computed: {
        ...mapGetters([
            'playlist'
        ])
    },
    mounted() {
      this.handlePlaylist(this.playlist);
    },
    activated () {
      this.handlePlaylist(this.playlist);
    },
    watch: {
        playlist(newVal) {
          this.handlePlaylist(newVal);
        }
    },
    methods: {
        handlePlaylist() {
          throw new Error('component must implement handlePlaylist method');
        }
    }
};
```

music-list.vue
```
import {playlistMixin} from 'common/js/mixin';
export default {
    mixins: [playlistMixin],
    methods: {
      handlePlaylist(playlist) {
        const bottom = playlist.length > 0 ? '60px' : '';
        this.$refs.list.$el.style.bottom = bottom;
        this.$refs.list.refresh();
      },
    }
}
```

# 推荐页/歌单详情页数据抓取
[https://y.qq.com/n/yqq/playlist/3269971894.html#](https://y.qq.com/n/yqq/playlist/3269971894.html#)

json数据
[https://c.y.qq.com/qzone/fcg-bin/fcg_ucc_getcdinfo_byids_cp.fcg](https://c.y.qq.com/qzone/fcg-bin/fcg_ucc_getcdinfo_byids_cp.fcg?type=1&json=1&utf8=1&onlysong=0&disstid=3269971894&format=jsonp&g_tk=5381&jsonpCallback=playlistinfoCallback&loginUin=2390803922&hostUin=0&format=jsonp&inCharset=utf8&outCharset=utf-8&notice=0&platform=yqq&needNewCode=0)

抓取数据 recommend.js
```
export function getSongList(disstid) {
  const url = 'https://c.y.qq.com/qzone/fcg-bin/fcg_ucc_getcdinfo_byids_cp.fcg';

  const data = Object.assign({}, commonParams, {
    disstid,
    type: 1,
    json: 1,
    utf8: 1,
    onlysong: 0,
    platform: 'yqq',
    hostUin: 0,
    needNewCode: 0
  });

  return jsonp(url, data, options);
}
```

配置跳转路由 router/config.js
```
{
      path: '/recommend',
      name: 'Recommend',
      component: Recommend,
      children: [
        {
          path: ':id',
          component: Disc
        }
      ]
    },

```

被跳转的页面 recommend/recommend.vue
js设置router
mapMutations 将item传入state
```
<div class="recommend-list">
          <h1 class="list-title">热门歌单推荐</h1>
          <ul>
            <li v-for="item in discList" @click="selectItem(item)" class="item">
              <div class="icon">
                <img v-lazy="item.imgurl" width="60" height="60" alt="">
              </div>
              <div class="text">
                <h2 class="name" v-html="item.creator.name"></h2>
                <p class="desc" v-html="item.dissname"></p>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div class="loading-container" v-show="!discList.length">
        <loading></loading>
      </div>
    </Scroll>
    <router-view></router-view>
    
import {mapMutations} from 'vuex';
  methods: {
    selectItem(item) {
      this.$router.push({
        path: `/recommend/${item.dissid}`
      });
      this.setDisc(item);
    },
    _getDiscList() {
      getDiscList().then((res) => {
        if (res.code === ERR_OK) {
           console.log(res.data.list);
          this.discList = res.data.list;
        }
      });
    },
    ...mapMutations({
      setDisc: 'SET_DISC'
    })
  }

```

跳转到的页面disc.vue
mapGetters获取state中的disc对象
```
<template>
  <transition name="slide">
    <music-list :title="title" :bg-image="bgImage" :songs="songs"></music-list>
  </transition>
</template>

<script type="text/ecmascript-6">
  import MusicList from 'components/music-list/music-list';
  import {getSongList} from 'api/recommend';
  import {ERR_OK} from 'api/config';
  import {mapGetters} from 'vuex';
  import {createSong} from 'common/js/song';

  export default {
    computed: {
      title() {
        return this.disc.dissname;
      },
      bgImage() {
        return this.disc.imgurl;
      },
      ...mapGetters([
        'disc'
      ])
    },
    data() {
      return {
        songs: []
      };
    },
    created() {
      this._getSongList();
    },
    methods: {
      _getSongList() {
        if (!this.disc.dissid) {
          this.$router.push('/recommend');
          return;
        }
        getSongList(this.disc.dissid).then((res) => {
          if (res.code === ERR_OK) {
            this.songs = this._normalizeSongs(res.cdlist[0].songlist);
          }
        });
      },
      _normalizeSongs(list) {
        let ret = [];
        list.forEach((musicData) => {
          if (musicData.songid && musicData.albummid) {
            ret.push(createSong(musicData));
          }
        });
        return ret;
      }
    },
    components: {
      MusicList
    }
  };
</script>

<style scoped lang="stylus" rel="stylesheet/stylus">
  .slide-enter-active, .slide-leave-active
    transition: all 0.3s

  .slide-enter, .slide-leave-to
    transform: translate3d(100%, 0, 0)
</style>
```

不能渲染出music-list,报错
```
Uncaught ReferenceError: jp1 is not defined
```
api/config.js中添加prefix
```
export const options = {
  param: 'jsonpCallback',
  prefix: 'jp'
};
```

#  排行页面布局介绍及排行榜数据抓取

## 排行榜页面
[https://m.y.qq.com/#toplist](https://m.y.qq.com/#toplist)

json数据
[https://c.y.qq.com/v8/fcg-bin/fcg_myqq_toplist.fcg](https://c.y.qq.com/v8/fcg-bin/fcg_myqq_toplist.fcg?g_tk=5381&uin=2390803922&format=json&inCharset=utf-8&outCharset=utf-8&notice=0&platform=h5&needNewCode=1&_=1500109137593)

## 榜单详情页
[https://y.qq.com/w/toplist.html?ADTAG=myqq&from=myqq&channel=10007100&id=4&type=top](https://y.qq.com/w/toplist.html?ADTAG=myqq&from=myqq&channel=10007100&id=4&type=top)

json数据XHR
[https://c.y.qq.com/v8/fcg-bin/fcg_v8_toplist_cp.fcg](https://c.y.qq.com/v8/fcg-bin/fcg_v8_toplist_cp.fcg?g_tk=5381&uin=2390803922&format=json&inCharset=utf-8&outCharset=utf-8&notice=0&platform=h5&needNewCode=1&tpl=3&page=detail&type=top&topid=4&_=1500125808009)



