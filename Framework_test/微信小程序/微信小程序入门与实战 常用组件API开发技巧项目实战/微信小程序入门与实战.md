<font color="#4590a3" size = "6px">微信小程序入门与实战</font>

<font color="#4590a3" size = "4px">7七月</font>

[TOC]


# 第1章 什么是微信小程序？

## 1-1 序：十几个小时的课程就这节最重要

知乎专栏：小楼昨夜又秋风

微信公众号：林间有风

学思维，API靠查文档

## 开篇及课程特色介绍

1. 本课程特点
2. 什么是微信小程序
3. 小程序的特点
4. 对开发者的影响
5. 小程序开发需要什么基础

**小程序基础知识**

- 文件路径

- 页面生命周期

- 常用组件

- API使用方法

- 使用template可以更好的封装UI和业务逻辑，增加复用性

## 直观感受一下微信小程序

张小龙这样定义：

- 不需要下载安装即可使用
- 用户“用完即走”，不用关心是否安装太多应用
- 应用将无处不在，随时可用

安装包 < 1MB

实际：下载安装包 -> 安装软件 -> 使用

B2C（人与商品）：京东、淘宝
P2P（人与人）：微信、QQ
C2P（人与服务）：小程序


小程序特点：

1. 业务逻辑简单
2. 使用频率低
3. 性能要求低

转账、淘票票、手机充值、生活缴费

|传统APP|微信小程序|
|---|---|
|体验差|流程简单|
|成本高|跨平台|

微信提供平台

## 小程序适合做什么样的应用

1. 小程序适合做简单的、用完即走的应用
2. 小程序适合低频的应用
3. 小程序适合性能要求不高的应用

✘ 不适合的：

- 知乎：社区型的，用户停留久；不满足低频；依赖系统推送，

- 斗鱼直播：用户停留久；不能多任务，来回切换，不记位置；

- 手游：性能达不到

✔ 适合的：

- 饿了吗

- 淘票票

- 滴滴打车

？ 中大型可以拆分功能做成小程序

- 豆瓣

- 美团

- 招商银行

## 对开发者的影响

- 短期内将提升市场对JavaScript程序员的需求量

- 小程序是0基础开发者很好的入门平台

- 小程序不可以使用现在已经存在的JavaScript组件库

- 开发环境和开发逻辑及其简单，非常适合新手入门

## 学习基础

js、ES6、CSS

数据绑定、数据优先

小程序没有DOM、template思想、支持ES6

# 第2章 小程序环境搭建与开发工具介绍

1. 申请小程序账号（appid）
2. 下载并安装微信开发者

## 申请appid

https://mp.weixin.qq.com/  注册小程序

账号：2390803922@qq.com
密码：aidashu99

登录后，设置，开发者ID：wxcf008778bf402345


## 下载并安装微信开发者工具

前往开发者工具下载页面

https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html

工具 -> 微信开发者工具 下载，安装

## 微信开发工具UI简介与小程序调试方法

创建page包含4个文件：test.js、test.json、test.wxml、test.wxss

小程序快捷键 https://developers.weixin.qq.com/miniprogram/dev/devtools/shortcut.html

自动编译

清缓存

设置->项目设置（或详情）： 查看项目配置信息

小程序：调试

console.log('logs',logs)

断点调试：

sources 找到文件，在某一行打断点，编译，鼠标悬停就可以看到值

Storage 缓存情况

AppData

Wxml

# 第3章 从一个简单的“欢迎“页面开始小程序之旅

## 本章内容简介

- 小程序文件类型与目录结构

- 注册小程序页面，view、image、text等组件的基本用法

- flex弹性盒子模型

- 移动端分辨率及小程序自适应单位RPX

## 官方种子项目介绍与小程序的文件结构

样式表和JSON配置有冲突，采用就近原则

页面层级最多5级

## 新建我们自己的项目：ReaderMovie

新建一个空白页面的项目

testProject
  - pages
      - welcome
          - welcome.js
          - welcome.json
          - welcome.wxml
          - welcome.wxss
  - app.js
  - app.json
  - app.wxss

## 开始制作项目启动页（如果出现错误，请参考 3-10 扩展）

配置需要显示哪个页面的路径：

https://developers.weixin.qq.com/miniprogram/dev/framework/config.html

框架 -> 配置 -> app.json配置项列表 pages

welcome/welcome.wxml

```xml
<view>
    <text>hello</text>
</view>
```

app.json

```json
{
  "pages": [
    "pages/welcome/welcome"
  ]
}
```

## 制作项目启动页（上）之自适应单位：RPX

文字需要text标签包裹

1，便于添加样式
2，只有text包裹的文字才会被长按选中复制，区别于HTML

设计稿建议以iPhone为基准，宽度750px,这样1px=1rpx

新增images文件夹，将logo.png图片烤人，跟文件路径"/"

welcome/welcome.wxml

```xml
<view>
  <image class="user-avatar" src="/images/logo.png"></image>
  <text>hello 友谊</text>
  <view>
    <text>开启小程序之旅</text>
  </view>
</view>
```
welcome/welcome.wxss

```css
.user-avatar {
  width: 200rpx;
  height: 200rpx;
}
```

## 制作项目启动页（中）之样式与弹性盒子模型

静态样式，添加 Class 放入 .wxss 样式表里，
动态样式，在标签上直接添加 style

## 制作项目启动页（下）之小程序app.json基础配置

全局样式放入app.wxss

```css
text {
  font-family: MicroSoft Yahei;
}
```

页面自动包裹一层page标签

welcome.wxss

```css
page {
  background-color: #b3d4db;
  height:100%;
}
```

修改导航栏背景色

app.json

```json
{
  "pages": [
    "pages/welcome/welcome"
  ],
  "window": {
    "navigationBarBackgroundColor": "#b3d4db"
  }
}
```


整个项目

welcome.wxml

```xml
<view class="container">
  <image class="user-avatar" src="/images/logo.png"></image>
  <text class="user-name"><text style="color: red">hello</text> 友谊</text>
  <view class="moto-container">
    <text class="moto">开启小程序之旅</text>
  </view>
</view>
```

welcome.wxss

```css
page {
  background-color: #b3d4db;
  height:100%;
}
.container {
  display:flex;
  flex-direction: column;
  align-items: center;
}
.user-name {
  margin-top: 100rpx;
  font-size: 32rpx;
  font-weight: bold;
}
.moto-container {
  margin-top: 200rpx;
  border: 1px solid #405f80;
  width: 200rpx;
  height: 80rpx;
  border-radius: 5px;
  text-align: center;
  line-height:80rpx;
}
.moto {
  color: #405f80;
  font-size: 22rpx;
  font-weight: bold;
}
.user-avatar {
  width: 200rpx;
  height: 200rpx;
  margin-top: 200rpx
}
```

app.json配置

```json
{
  "pages": [
    "pages/welcome/welcome"
  ],
  "window": {
    "navigationBarBackgroundColor": "#b3d4db"
  }
}
```

app.wxss全局样式

```css
text {
  font-family: MicroSoft Yahei;
}
```

## 章节扩展（可选观看1）移动端分辨率精讲

移动设备的分辨率与rpx

- 从一张设计图的实现说起

- 为什么模拟器下ip 的分辨率是375 而设计图一般给750

- 如何适配不同的机型


pt、px、PPI（DPI）

- pt也称为逻辑分辨率

- pt的大小和屏幕尺寸有关系，简单可以理解为长度和视
觉单位

- px指物理分辨率，和屏幕尺寸没有关系点能有大小吗？

1个pt可以由1个px构成，也可以由2个，还可以是3个甚至更多组成

iPhone6下2个px才构成一个pt

rpx的作用：

ip6设计稿屋里像素750*1334为视觉稿进行设计

ip6下 1px = 1rpx = 0.5pt
ip6 plus下 1px = 0.6rpx

使用rpx,小程序会自动在不同的分辨率下进行转换，而使用px为单位不会

有的文字大小不需要转换就直接使用px为单位


# 第4章 第二个页面：新闻阅读列表

## 第四章课程简介

- swiper组件
- app.json 里的关于导航栏、标题配置
- page页面与应用程序的生命周期
- 数据绑定（核心知识）
- 数据绑定的运算与逻辑
- AppData区域介绍
- 事件与事件对象
- 缓存
- 列表渲染（核心知识）
- template模板的使用（核心知识）

## 使用Swiper组件构建轮播图

app.json 中 pages 里面的第一条默认显示，每一个页面都需要在这里注册

视图容器 -> swiper
https://developers.weixin.qq.com/miniprogram/dev/component/swiper.html


新增pages/posts/....

post.wxml
```xml
<view>
  <swiper indicator-dots="true" autoplay='true' interval='2000'>
    <swiper-item>
      <image src="/images/wx.png"></image>
    </swiper-item>
    <swiper-item>
      <image src="/images/vr.png"></image>
    </swiper-item>
    <swiper-item>
      <image src="/images/iqiyi.png"></image>
    </swiper-item>
  </swiper>
</view>
```

post.wxss

```css
swiper {
  width: 100%;
  height: 500rpx;
}

swiper image {
  width: 100%;
  height: 500rpx;
}

```

app.json

```json
{
  "pages": [
    "pages/posts/post",
    "pages/welcome/welcome"
  ],
  "window": {
    "navigationBarBackgroundColor": "#b3d4db"
  }
}
```

## 构建新闻列表（上）

两个页面需要不同的导航栏背景色

posts/post.json

```json
{
  
 "navigationBarBackgroundColor": "#405f80",
 "navigationBarTitleText": "文与字"
}
```

app.json

```json
{
  "pages": [
    "pages/posts/post",
    "pages/welcome/welcome"
  ],
  "window": {
    "navigationBarBackgroundColor": "#b3d4db"
  }
}
```


控制水平用rpx，垂直用px

post.wxml

```xml
<view>
  <swiper indicator-dots="true" autoplay='true' interval='5000'>
    <swiper-item>
      <image src="/images/wx.png"></image>
    </swiper-item>
    <swiper-item>
      <image src="/images/vr.png"></image>
    </swiper-item>
    <swiper-item>
      <image src="/images/iqiyi.png"></image>
    </swiper-item>
  </swiper>

  <view class="post-container">
    <view class="post-author-date">
      <image class="post-author" src="/images/avatar/1.png"></image>
      <text class="post-date">nov 25 2016</text>
    </view>
    <text class="post-title">正是虾肥蟹壮时</text>
    <image class="post-image" src="/images/post/crab.png"></image>
    <text class="post-content"></text>
    <view class="post-like">
      <image class="post-like-image" src="../../images/icon/chat.png"></image>
      <text class="post-like-font">92</text>
      <image class="post-like-image" src="/images/icon/view.png"></image>
      <text class="post-like-font">65</text>
    </view>
  </view>
</view>
```

post.wxss

```css
swiper {
  width: 100%;
  height: 600rpx;
}

swiper image {
  width: 100%;
  height: 600rpx;
}

.post-container {
  display: flex;
  flex-direction: column;
  margin: 20rpx 0 40rpx 0;
  background-color: #fff;
  border-bottom: 1px solid #ededed;
  border-top: 1px solid #ededed;
  padding-bottom: 5px;
}

.post-author-date {
  margin: 10rpx 0 20rpx 10rpx;
}

.post-author {
  width: 60rpx;
  height: 60rpx;
  vertical-align: middle;
}

.post-date {
  margin-left: 20rpx;
  vertical-align: middle;
  margin-bottom: 10px;
  font-size: 26rpx;
}

.post-title {
  font-size: 34rpx;
  font-weight: bold;
  color: #333;
  margin-bottom: 10px;
}

.post-image {
  margin-left: 16px;
  width: 100%;
  height: 340rpx;
  margin: auto 0;
  margin-bottom: 15px;
}

.post-content {
  color: #666;
  font-size: 28rpx;
  margin-bottom: 20rpx;
  margin-left: 20rpx;
  letter-spacing: 2rpx;
  line-height: 40rpx;
}

.post-like {
  font-size: 13px;
  flex-direction: row;
  line-height: 16px;
  margin-left: 10px;
}

.post-like-image {
  width: 16px;
  height: 16px;
  margin-right: 8px;
  vertical-align: middle;
}

.post-like-font {
  vertical-align: middle;
  margin-right: 20px;
}
```

## js文件结构与Page页面的生命周期

编写post.js

page快速生成

[小程序生命周期函数](https://developers.weixin.qq.com/miniprogram/dev/framework/app-service/page.html)

⓵ onLoad 页面加载
⓶ onShow 页面显示
⓷ onReady 页面初次渲染完成

```js
Page({

  /**
   * 页面的初始数据
   */
  data: {
    
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
    
  },

  /**
   * 生命周期函数--监听页面初次渲染完成
   */
  onReady: function () {
    
  },

  /**
   * 生命周期函数--监听页面显示
   */
  onShow: function () {
    
  },

  /**
   * 生命周期函数--监听页面隐藏
   */
  onHide: function () {
    
  },

  /**
   * 生命周期函数--监听页面卸载
   */
  onUnload: function () {
    
  },

  /**
   * 页面相关事件处理函数--监听用户下拉动作
   */
  onPullDownRefresh: function () {
    
  },

  /**
   * 页面上拉触底事件的处理函数
   */
  onReachBottom: function () {
    
  },

  /**
   * 用户点击右上角分享
   */
  onShareAppMessage: function () {
    
  }
})

```

## {{数据绑定}}基础

[框架->视图层->数据绑定](https://developers.weixin.qq.com/miniprogram/dev/framework/view/wxml/data.html)

post.js

```js
Page({

  /**
   * 页面的初始数据
   */
  data: {
    date: 'nov 25 2016'
  },
})
```

在页面中可以直接使用

post.wxml

```xml
<text class="post-date">{{date}}</text>
```


小程序是单向数据绑定

post.js

```js
Page({
  data: {
   
  },
  onLoad: function (options) {
    var post_content = {
      date: 'Sep 18 2016',
      title: '正是虾肥蟹壮时'
    },
    this.setData(post_content)
  }
})
```

相当于

post.js

```js
Page({
  data: {
      date: 'Sep 18 2016',
      title: '正是虾肥蟹壮时'
  },
  onLoad: function (options) {
  }
})
```



当属性涉及boolean转换的时候，需要注意
```html
// 有效
<swiper vertical="{{false}}"></swiper>
// 无效
<swiper vertical="false"></swiper>
```

控制元素显示隐藏

可以隐藏
```html
<image wx:if="{{false}}"></image>
```

## 使用列表渲染wx-for改写新闻列表

https://developers.weixin.qq.com/miniprogram/dev/framework/view/wxml/list.html

新增与pages页面同级的data/posts-data.js

```js
var local_database = [
    {
        date: "Sep 18 2016",
        title: "正是虾肥蟹壮时",
        imgSrc: "/images/post/crab.png",
        avatar: "/images/avatar/1.png",
        content: "菊黄蟹正肥，品尝秋之味。徐志摩把,“看初花的荻芦”和“到楼外楼吃蟹”,并列为秋天来杭州不能错过的风雅之事；用林妹妹的话讲是“螯封嫩玉双双满，",
        reading: "112",
        collection: "96",
        headImgSrc: "/images/post/crab.png",
        author: "林白衣",
        dateTime: "24小时前",
        detail: "菊黄蟹正肥，品尝秋之味。徐志摩把“看初花的荻芦”和“到楼外楼吃蟹”并列为秋天来杭州不能错过的风雅之事；用林妹妹的话讲是“螯封嫩玉双双满，壳凸红脂块块香”；在《世说新语》里，晋毕卓更是感叹“右手持酒杯，左手持蟹螯，拍浮酒船中，便足了一生矣。”漫漫人生长路，美食与爱岂可辜负？于是作为一个吃货，突然也很想回味一下属于我的味蕾记忆。记忆中的秋蟹，是家人的味道，弥漫着浓浓的亲情。\n\n是谁来自山川湖海，却囿于昼夜，厨房与爱？ 是母亲，深思熟虑，聪明耐心。吃蟹前，总会拿出几件工具，煞有介事而乐此不疲。告诉我们螃蟹至寒，需要佐以姜茶以祛寒，在配备的米醋小碟里，亦添入姜丝与紫苏，前者驱寒后者增香。泡好菊花茶，岁月静好，我们静等。",
        postId: 0,
        music: {
            url: "http://ws.stream.qqmusic.qq.com/C100003507bR0gDKBm.m4a?fromtag=38",
            title: "夜夜夜夜-齐秦",
            coverImg: "http://y.gtimg.cn/music/photo_new/T002R150x150M000001TEc6V0kjpVC.jpg?max_age=2592000"
        }
    },
    ...
]
```

post.js

```js
var postsData = require('../../data/posts-data.js');

Page({
  data: {
    
  },
  onLoad: function (options) {
    this.setData({postList: postsData.postList})
  }
```

post.wxml 使用

```xml
  <block wx:for="{{postList}}" wx:for-item="item">
    <view class="post-container">
      <view class="post-author-date">
        <image class="post-author" src="/images/avatar/1.png">{{item.avatar}}</image>
        <text class="post-date">{{item.date}}</text>
      </view>
      <text class="post-title">{{itemName.title}}</text>
      <image class="post-image" src="{{item.imgSrc}}"></image>
      <text class="post-content">{{item.content}}</text>
      <view class="post-like">
        <image class="post-like-image" src="../../images/icon/chat.png"></image>
        <text class="post-like-font">{{item.collection}}</text>
        <image class="post-like-image" src="/images/icon/view.png"></image>
        <text class="post-like-font">{{item.reading}}</text>
      </view>
    </view>
  </block>

```

## 小程序的事件机制（冒泡与非冒泡）

[框架->视图层->事件](https://developers.weixin.qq.com/miniprogram/dev/framework/view/wxml/event.html)

从welcome页面跳转至posts页面

welcome.wxml
```xml
<view class="container">
  <image class="user-avatar" src="/images/logo.png"></image>
  <text class="user-name"><text style="color: red">hello</text> 友谊</text>
  <view class="moto-container" bindtap='onTap'>
    <text class="moto">开启小程序之旅</text>
  </view>
</view>
```

pages/welcome/welcome.js
```js
Page({
  data: {
  
  },
  onTap:function() {
    // wx.navigateTo({
    //   url: '../posts/post'
    // });
    wx.redirectTo({
      url: '../posts/post',
    })
  },
  ...
})
```

**navigateTo 与 redirectTo 的2点区别**

❶

- wx.navigateTo 从父级跳到子级页面，可以返回

- wx.redirectTo 同级页面的跳转，没有返回按钮

❷

wx.navigateTo 与 wx.redirectTo 生命周期，

onUnload、onHide 表现不同

- wx.navigateTo 在跳转时，执行的是 “onHide”

- wx.redirectTo 在跳转时，执行的是 “onUnload”

pages/welcome/welcome.js
```js
Page({
  data: {
  
  },
  onTap:function() {
    wx.navigateTo({
      url: '../posts/post'
    });
    // wx.redirectTo({
    //   url: '../posts/post',
    // })
  },


  onHide: function () {
    console.log('hide')
  },

  onUnload: function () {
     console.log('unload')
  },
```

**onUnload与onHide**

**小程序上面tap、touchmove等事件 冒泡**

https://developers.weixin.qq.com/miniprogram/dev/framework/view/wxml/event.html


非冒泡事件，如：

- <form/>的submit事件，

- <input/>的input事件，

- <scroll-view/>的scroll事件，

- 其他组件自定义事件

*bind事件绑定不会阻止冒泡事件向上冒泡，catch事件绑定可以阻止冒泡事件向上冒泡。*

catchtap能阻止事件冒泡

```
  <view class="moto-container" bindtap='onTap'>
    <text catchtap="handleTap" class="moto">开启小程序之旅</text>
  </view>
```

# 第5章 小程序的模板化与模块化

## 将业务中的数据分离到单独的数据文件中

格式化代码：alt + shift + F

require('相对路径')


post.js
```
var postsData = require('../../data/posts-data.js');

Page({
  data: {
    // 小程序总是会读取data对象来做数据绑定
    // 发生在onLoad事件之后
  },
  onLoad: function (options) {
    // this.data.postList = postsData.postList;
    this.setData({postList: postsData.postList})
  },
})
```

this.data.postList = postsData.postList; 是无效的，

## template模板的使用

小程序中，模板文件里脚本文件没有效果，不需要定义。

小程序只是实现了模板化编程，并没有实现模块化编程

新建post/post-item/post-item-template.wxml 模板

```xml
<template name="postItem">
  <view class="post-container">
    <view class="post-author-date">
      <image class="post-author" src="/images/avatar/1.png">{{item.avatar}}</image>
      <text class="post-date">{{item.date}}</text>
    </view>
    <text class="post-title">{{itemName.title}}</text>
    <image class="post-image" src="{{item.imgSrc}}"></image>
    <text class="post-content">{{item.content}}</text>
    <view class="post-like">
      <image class="post-like-image" src="../../images/icon/chat.png"></image>
      <text class="post-like-font">{{item.collection}}</text>
      <image class="post-like-image" src="/images/icon/view.png"></image>
      <text class="post-like-font">{{item.reading}}</text>
    </view>
  </view>
</template>
```

post.wxml 中使用模板

```xml
<import src="post-item/post-item-template.wxml" />

<view>

  <block wx:for="{{postList}}" wx:for-item="item" wx:key="unique">
    <template is="postItem" data="{{item}}"/>
  </block>

</view>
```


样式复用

posts/post-item/post-item-template.wxss

```css
...
```

post.wxss 引用样式

```css
@import 'post-item/post-item-template.wxss';
...
```

# 第6章 构建新闻详情页面

## 从文章列表跳转到新闻详情页面（组件自定义属性及获取属性）

使用{{...data}}

post.wxml

```xml
<import src="post-item/post-item-template.wxml" />

<view>

  <block wx:for="{{postList}}" wx:for-item="item" wx:key="unique">
    <template is="postItem" data="{{item}}"/>
  </block>

</view>

```

post-item/post-item-template.wxml

```xml
<template name="postItem">
  <view class="post-container">
    <view class="post-author-date">
      <image class="post-author" src="/images/avatar/1.png">{{item.avatar}}</image>
      <text class="post-date">{{item.date}}</text>
    </view>
    <text class="post-title">{{itemName.title}}</text>
    <image class="post-image" src="{{item.imgSrc}}"></image>
    <text class="post-content">{{item.content}}</text>
    <view class="post-like">
      <image class="post-like-image" src="../../images/icon/chat.png"></image>
      <text class="post-like-font">{{item.collection}}</text>
      <image class="post-like-image" src="/images/icon/view.png"></image>
      <text class="post-like-font">{{item.reading}}</text>
    </view>
  </view>
</template>
```

使用{{...data}}可以让 {{item.avatar}} 变为{{avatar}}


post.wxml

```xml
<import src="post-item/post-item-template.wxml" />

<view>

  <block wx:for="{{postList}}" wx:for-item="item" wx:key="unique">
    <template is="postItem" data="{{...item}}"/>
  </block>

</view>

```

post-item/post-item-template.wxml

```xml
<template name="postItem">
  <view class="post-container">
    <view class="post-author-date">
      <image class="post-author" src="/images/avatar/1.png">{{avatar}}</image>
      <text class="post-date">{{date}}</text>
    </view>
    <text class="post-title">{{title}}</text>
    <image class="post-image" src="{{imgSrc}}"></image>
    <text class="post-content">{{item.content}}</text>
    <view class="post-like">
      <image class="post-like-image" src="../../images/icon/chat.png"></image>
      <text class="post-like-font">{{collection}}</text>
      <image class="post-like-image" src="/images/icon/view.png"></image>
      <text class="post-like-font">{{reading}}</text>
    </view>
  </view>
</template>
```


post.wxml 跳转至 post-detail/post-detail.wxml 页面

```xml
<import src="post-item/post-item-template.wxml" />
<view>
  ...
  <block wx:for="{{postList}}" wx:for-item="item" wx:key="unique">
    <view catchtap="onPostTap" data-postId="{{item.postId}}">
      <template is="postItem" data="{{...item}}" />
    </view>
  </block>
</view>
```

✔ 跳转事件在 post.wxml 页面添加即可，如果加在template标签上是无效的，因为template标签只是占位符，不实际存在，解决办法，在外面包裹一层<view>标签。<view catchtap="onPostTap">

✘ 跳转事件在post-item-template 上添加也可以执行，但是影响组件复用，只能处理相同的一个事件，故不可取。


**自定义组件添加属性及获取：**

<view catchtap="onPostTap" data-postId="{{item.postId}}">

通过在元素上添加 data-propertyName 属性来定义，在事件中通过propertyNameevent.currentTarget.dataset.propertyName

☞ 注：属性定义添加data-前缀，用“-”的属性名，在获取的时候，自动转换为小写字母，但是有“-”的时候变成驼峰式。

post.js

```js

Page({
  onPostTap: function (event) {
    wx.navigateTo({
      url: 'post-detail/post-detail',
    });
    var postId = event.currentTarget.dataset.postid; console.log(event.currentTarget.dataset.postid)
  },
  ...
})
```

## 先静后动，构建新闻详情页面样式


## 配置全局导航栏颜色

## 使用数据填充新闻详情页面

post.xml

```xml
  <block wx:for="{{postList}}" wx:for-item="item" wx:key="unique">
    <view catchtap="onPostTap" data-postId="{{item.postId}}">
      <template is="postItem" data="{{...item}}" />
    </view>
  </block>
```

post.js

```js

Page({
  onPostTap: function (event) {
    var postId = event.currentTarget.dataset.postid;
    wx.navigateTo({
      url: 'post-detail/post-detail?id=' + postId,
    });
  },
  ...
})
```

在post-detail.js 里面onLoad函数的options可以获取父页面传递过来的值

```js
Page({
  onLoad: function (options) {
    var postId = options.id
    console.log(postId);
  },
})
```

### 在post-detail页面根据不同postid显示不同页面

post.wxml 和 post.js 同上，

post-detail.js 设置data里面的postData

```js
var postsData = require('../../../data/posts-data.js');
Page({
  data: {
    
  },
  onLoad: function (option) {
    var postId = option.id;
    this.data.currentPostId = postId;
    var postData = postsData.postList[postId];
    this.setData({
      postData: postData
    })
  },
})
```

post-detail.wxml 显示

```xml
<view class="container">
  ...
  <text class="detail">{{postData.detail}}</text>
</view>
```

## 缓存Storage的基本用法

https://developers.weixin.qq.com/miniprogram/dev/api/data.html

wx.getStorageSync("postsCollected");


## 使用缓存实现文章收藏功能

所有缓存的收藏列表数据格式是一个对象postsCollected

```js
postsCollected = {
  0: false,
  1: true,
  2: false,
}
```
post-detail.wxml

```xml
<image wx:if="{{collected}}" catchtap="onCollectionTap"  src="/images/icon/collection.png"></image>
 <image wx:else catchtap="onCollectionTap" src="/images/icon/collection-anti.png"></image>

```

post-detail.js

```js
var postsData = require('../../../data/posts-data.js');
Page({
  data: {

  },
  onCollectionTap: function(event) {
    
    var postsCollected = wx.getStorageSync("posts_collected");

    var postCollected  = postsCollected[this.data.currentPostId];
    // 收藏变未收藏，未收藏变收藏
    postCollected = !postCollected;
    // 
    postsCollected[this.data.currentPostId] = postCollected;
    // 更新缓存
    wx.setStorageSync("posts_collected", postsCollected);
    // 更新数据绑定变量，从而实现切换图片
    this.setData({
      collected: postCollected
    })
  },

  onLoad: function (option) {
    var postId = option.id;
    this.data.currentPostId = postId;
    var postData = postsData.postList[postId];
    this.setData({
      postData: postData
    });
    // 获取所有缓存的收藏列表
    var postsCollected = wx.getStorageSync("posts_collected");

    if (postsCollected) {
      // 获取当前文章是否被缓存
      var postCollected = postsCollected[postId];
      if (postCollected) {
        this.setData({
          collected: postCollected
        })
      }
    } else {
      postsCollected ={};
      postsCollected[postId] = false;
      wx.setStorageSync("posts_collected", postsCollected);
    }
  },
  ...
})
```

## 交互反馈 wx.showToast

https://developers.weixin.qq.com/miniprogram/dev/api/api-react.html#wxshowtoastobject

```js
wx.showToast({
 title: postCollected ? '收藏成功' : '取消收藏',
 duration: 1000,
 success: function() {

 },
 fail: function() {

 },
 complete: function() {
   
 }
})

```

```js
    showToast: function (postsCollected, postCollected) {
        // 更新文章是否的缓存值
        wx.setStorageSync('posts_collected', postsCollected);
        // 更新数据绑定变量，从而实现切换图片
        this.setData({
            collected: postCollected
        })
        wx.showToast({
            title: postCollected ? "收藏成功" : "取消成功",
            duration: 1000,
            icon: "success"
        })
    },
```

## 操作反馈wx.showModal

https://developers.weixin.qq.com/miniprogram/dev/api/api-react.html#wxshowmodalobject

```js
    showModal: function (postsCollected, postCollected) {
        var that = this;
        wx.showModal({
            title: "收藏",
            content: postCollected ? "收藏该文章？" : "取消收藏该文章？",
            showCancel: "true",
            cancelText: "取消",
            cancelColor: "#333",
            confirmText: "确认",
            confirmColor: "#405f80",
            success: function (res) {
                if (res.confirm) {
                    wx.setStorageSync('posts_collected', postsCollected);
                    // 更新数据绑定变量，从而实现切换图片
                    that.setData({
                        collected: postCollected
                    })
                }
            }
        })
    },
```

post-detail.js 收藏示例
```js
var postsData = require('../../../data/posts-data.js');
Page({
  data: {

  },
  onCollectionTap: function(event) {
    
    var postsCollected = wx.getStorageSync("posts_collected");

    var postCollected  = postsCollected[this.data.currentPostId];
    // 收藏变未收藏，未收藏变收藏
    postCollected = !postCollected;
    // 
    postsCollected[this.data.currentPostId] = postCollected;

    this.showToast(postsCollected, postCollected);

  },

  showModal: function (postsCollected, postCollected) {
    var that = this;
    wx.showModal({
      title: "收藏",
      content: postCollected ? "收藏该文章？" : "取消收藏该文章？",
      showCancel: "true",
      cancelText: "取消",
      cancelColor: "#333",
      confirmText: "确认",
      confirmColor: "#405f80",
      success: function (res) {
        if (res.confirm) {
          wx.setStorageSync('posts_collected', postsCollected);
          // 更新数据绑定变量，从而实现切换图片
          that.setData({
            collected: postCollected
          })
        }
      }
    })
  },

  showToast: function (postsCollected, postCollected) {
    // 更新文章是否的缓存值
    wx.setStorageSync('posts_collected', postsCollected);
    // 更新数据绑定变量，从而实现切换图片
    this.setData({
      collected: postCollected
    })

    wx.showToast({
      title: postCollected ? "收藏成功" : "取消成功",
      duration: 1000,
      icon: "success"
    })
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (option) {
    var postId = option.id;
    this.data.currentPostId = postId;
    var postData = postsData.postList[postId];
    this.setData({
      postData: postData
    });
    // 获取所有缓存的收藏列表
    var postsCollected = wx.getStorageSync("posts_collected");

    if (postsCollected) {
      // 获取当前文章是否被缓存
      var postCollected = postsCollected[postId];
      if (postCollected) {
        this.setData({
          collected: postCollected
        })
      }
    } else {
      postsCollected ={};
      postsCollected[postId] = false;
      wx.setStorageSync("posts_collected", postsCollected);
    }

  },
})
```

## 交互反馈wx.showActionSheet

https://developers.weixin.qq.com/miniprogram/dev/api/api-react.html#wxshowactionsheetobject

post-detail.wxml

```xml
<view class="circle-img">
 <image wx:if="{{collected}}" catchtap="onCollectionTap"  src="/images/icon/collection.png"></image>
 <image wx:else catchtap="onCollectionTap" src="/images/icon/collection-anti.png"></image>
 <image catchtap="onShareTap" src="/images/icon/share.png" class="share-img"></image>
</view>
```

post-detail.js

```js
  onShareTap: function(event) {
    var itemList = [
      "分享给微信好友",
      "分享到朋友圈",
      "分享到QQ",
      "分享到微博"
    ];
    wx.showActionSheet({
      itemList: itemList,
      itemColor: "#405f80",
      success: function(res) {
        // res.cancel 用户是不是点击了取消按钮
        // res.tapIndex 数组元素的序号，从0开始
        wx.showModal({
          title: '用户' + itemList[res.tapIndex],
          content: "用户是否取消？" + res.cancel + "现在无法实现分享功能，什么时候能支持呢",
        })
      }
    })
  },

```

## 同步异步方法对比

post-detail.js
```js
  /**
   * 是否收藏页面
   */
  onCollectionTap: function(event) {
    this.getPostsCollectedSyc(); // 推荐同步
    // this.getPostsCollectedAsy(); // 异步方法
    
  },
  // 异步获取收藏
  getPostsCollectedAsy: function() {
    var that = this;
    wx.getStorage({
      key: 'posts_collected',
      success: function(res) {
        var postsCollected = res.data;
        var postCollected = postsCollected[that.data.currentPostId];
        // 收藏变未收藏，未收藏变收藏
        postCollected = !postCollected;
        // 
        postsCollected[that.data.currentPostId] = postCollected;

        that.showToast(postsCollected, postCollected);
      },
    })
  },


  // 从本地缓存中同步获取
  getPostsCollectedSyc: function() {

    var postsCollected = wx.getStorageSync("posts_collected");

    var postCollected = postsCollected[this.data.currentPostId];
    // 收藏变未收藏，未收藏变收藏
    postCollected = !postCollected;
    // 
    postsCollected[this.data.currentPostId] = postCollected;

    this.showToast(postsCollected, postCollected);

  },

```


## playBackgroundAudio-音乐播放基本实现


https://developers.weixin.qq.com/miniprogram/dev/api/media-background-audio.html


https://developers.weixin.qq.com/miniprogram/dev/component/audio.html#audio


```js
  // 音乐播放
  onMusicTap: function(event) {
    var currentPostId = this.data.currentPostId;
    var postData = postsData.postList[currentPostId];
    var isPlayingMusic = this.data.isPlayingMusic;
    if (isPlayingMusic) {
      wx.pauseBackgroundAudio();
      this.setData({ isPlayingMusic: false});
    } else {
      wx.playBackgroundAudio({
        dataUrl: postData.music.url,
        title: postData.music.title,
        coverImg: postData.music.coverImg,
      
      });
      this.setData({ isPlayingMusic: true })
    }
   
  },

```

## 修复音乐播放闪退的问题

原因：url不对

## 加入不同的音乐，个性化音乐播放

## 监听播放事件完善音乐播放

https://developers.weixin.qq.com/miniprogram/dev/api/media-background-audio.html#wxonbackgroundaudioplaycallback

```js
onLoad: function (option) {
    
    // 监听音乐播放
    var that = this;
    wx.onBackgroundAudioPlay(function() {
      that.setData({ isPlayingMusic: true})
    });
    wx.onBackgroundAudioPause(function () {
      that.setData({ isPlayingMusic: false })
    });
  },
}
```


## 应用程序生命周期

问题：播放音乐后离开页面，再次进入页面，播放状态始终是初始化的 isPlayingMusic

缓存不能解决

使用全局变量机制

定义全局变量

app.js
```js
App({
  globalData: {
    g_isPlayingMusic: false
  }
})

```
获取全局变量

post-detail.js

```js
var app = getApp();
  onLoad: function (option) {
    console.log(app.globalData.g_isPlayingMusic)

```

post-detail.js
```js
var app = getApp();

Page({
  ...
  onLoad: function (option) {
    ...
    if (app.globalData.g_isPlayingMusic) {
      this.setData({ isPlayingMusic: true });
    }

    this.setMusicMonitor();
  },

  // 页面初始化的时候，监听音乐播放状态
  setMusicMonitor: function() {
    
    var that = this;
    // 监听音乐播放。
    wx.onBackgroundAudioPlay(function () {
      that.setData({ isPlayingMusic: true });
      app.globalData.g_isPlayingMusic = true;
    });
    // 监听音乐暂停。
    wx.onBackgroundAudioPause(function () {
      that.setData({ isPlayingMusic: false });
      app.globalData.g_isPlayingMusic = false;
    });
  }
})

```

## 音乐播放最终章

全局变量之后，如果播放一首音乐，再切换到另外一首，另外一首也是播放图标，不符合逻辑。

解决：新增一个全局变量记录当前播放的是哪首歌，

下次页面初始化的时候，音乐在播放，并且当前播放曲目的索引和进入页面的id一致，一致才修改播放按钮为暂停状态。

post-detail.js

```js
var postsData = require('../../../data/posts-data.js');
var app = getApp();

Page({

  /**
   * 页面的初始数据
   */
  data: {
    isPlayingMusic: false
  },

  onLoad: function (option) {

    if (app.globalData.g_isPlayingMusic && app.globalData.g_currentMusicPostId === this.data.currentPostId) {
      this.setData({ isPlayingMusic: true });
    }
    
    this.setMusicMonitor();
  },

  // 播放音乐事件
  onMusicTap: function(event) {

    var currentPostId = this.data.currentPostId;
    var postData = postsData.postList[currentPostId];
    var isPlayingMusic = this.data.isPlayingMusic;

    if (isPlayingMusic) {

      wx.pauseBackgroundAudio();
      this.setData({ isPlayingMusic: false});
      app.globalData.g_currentMusicPostId = null;

    } else {

      wx.playBackgroundAudio({
        dataUrl: postData.music.url,
        title: postData.music.title,
        coverImg: postData.music.coverImg,
      });
      this.setData({ isPlayingMusic: true });
      app.globalData.g_currentMusicPostId = currentPostId;
    }

  },
})
```

## 真机如何清除缓存与template内路径问题

在页面放置一个按钮，调用wx.clearStorage()方法

多个页面引用一个模板时，模板用绝对路径就不会存在找不到的情况。

# 第7章 开始制作电影资讯页面

## 重要补充说明（关于API调用403）

微信里不允许更改referer、user-agent


app.js
```js
App({
  globalData: {
    g_isPlayingMusic: false,
    g_currentMusicPostId: null,
    doubanBase: "http://t.yushu.im"
  }
})

```

## Banner轮播图跳转文章详情

post.wxml
```xml
  <swiper catchtap="onSwiperTap" indicator-dots="true" autoplay='true' interval='5000'>
    <swiper-item>
      <image src="/images/wx.png" data-postId="3"></image>
    </swiper-item>
    <swiper-item>
      <image src="/images/vr.png" data-postId="4"></image>
    </swiper-item>
    <swiper-item>
      <image src="/images/iqiyi.png" data-postId="5"></image>
    </swiper-item>
  </swiper>
```

post.js
```js
  onSwiperTap: function(event) {
    var postId = event.target.dataset.postid;
    wx.navigateTo({
      url: 'post-detail/post-detail?id=' + postId,
    });
  },

```

event.target 指具体触发的那个元素

event.curentTarget 指绑定事件的那个元素

## 补充内容：tab选项卡课前准备

如果要跳转到一个带tab选项卡的页面，必须使用wx.switchTab 这个新增方法。

但如果要跳转到一个不带tab选项卡的页面，还是需要使用redirect或navigate

从welcome页面跳到post/movies Tab页面
welcome.js
```js
  onTap:function(event) {
    // wx.navigateTo({
    //   url: '../posts/post'
    // });

    // wx.redirectTo({
    //   url: '../posts/post'
    // });

    wx.switchTab({
      url: '../posts/post'
    })
  },

```

## 给项目加入tab选项卡

https://developers.weixin.qq.com/miniprogram/dev/framework/

新建movies的4个文件

配置app.json

```js
{
  "pages": [
    "pages/posts/post",
    "pages/welcome/welcome",
    "pages/posts/post-detail/post-detail",
    "pages/movies/movies"
  ],
  "window": {
    "navigationBarBackgroundColor": "#405f80"
  },
  "tabBar": {
    "list": [
      {
        "pagePath": "pages/movies/movies",
        "text": "电影"
      },
      {
        "pagePath": "pages/posts/post",
        "text": "文章"
      }
    ]
  }
}
```


## 完善tab选项卡

app.json

```json
{
  "pages": [
    "pages/posts/post",
    "pages/welcome/welcome",
    "pages/posts/post-detail/post-detail",
    "pages/movies/movies"
  ],
  "window": {
    "navigationBarBackgroundColor": "#405f80"
  },
  "tabBar": {
    "list": [
      {
        "pagePath": "pages/posts/post",
        "text": "阅读",
        "iconPath": "images/tab/yuedu.png",
        "selectedIconPath": "images/tab/yuedu_hl.png"
      },
      {
        "pagePath": "pages/movies/movies",
        "text": "电影",
        "iconPath": "images/tab/dianying.png",
        "selectedIconPath": "images/tab/dianying_hl.png"
      }
    
    ],
    "borderStyle": "white"
  }
}

```

## 补充内容：为什么redirectTo不出现选项卡

现在需要使用 wx.switchTab() 方法 才会跳转

## 电影页面嵌套template分析

在app.json中pages配置路径时，可以快速生成4个文件

## 3个嵌套template标签的实现

https://developers.douban.com/wiki/?title=movie_v2

项目结构

- movies
    - movies.wxml等
    - movie-list
        - movie-list-template.wxml等
    - movie
        - movie-template.wxml等
    - stars
        - stars-template.wxml等


movies.wxml/movie-list-template.wxml/movie-template.wxml/stars-template.wxml


movies.wxml
```xml
<import src="movie-list/movie-list-template.wxml" />

<view>
  <template is="movieListTemplate"></template>
  <template is="movieListTemplate"></template>
  <template is="movieListTemplate"></template>
</view>
```

movie-list-template.wxml

```xml
<import src="../movie/movie-template.wxml" />
<template name="movieListTemplate">
  <view>
    <view>
      <text>正在热映</text>
      <view>
        <text>更多</text>
        <image src="/images/icon/arrow-right.png"></image>
      </view>
    </view>
    <template is="movieTemplate"></template>
    <template is="movieTemplate"></template>
    <template is="movieTemplate"></template>
  </view>
</template>
```

movie-template.wxml
```xml
<import src="../stars/stars-template.wxml" />
<template name="movieTemplate">
  <view>
    <image src=""></image>
    <text>你的名字</text>
    <template is="starsTemplate"></template>
  </view>
</template>
```

stars-template.wxml
```xml
<template name="starsTemplate">
  <view>
    <image src="/images/icon/star.png"></image>
    <image src="/images/icon/star.png"></image>
    <image src="/images/icon/star.png"></image>
    <image src="/images/icon/star.png"></image>
    <image src="/images/icon/star.png"></image>
    <text></text>
  </view>
</template>
```

## stars template的样式实现
  
同上模板嵌套引用，编写好的样式我们也需要嵌套调用

movies.wxss
```css
@import "movie-list/movie-list-template.wxss"
```

movie-list-template.wxss
```css
@import "../movie/movie-template.wxss"
```

movie-template.wxss
```css
@import "../stars/stars-template.wxss";
```

## RESTful API简介及调用豆瓣API

https://developers.douban.com/wiki/?title=guide

http://t.yushu.im/v2/movie/top250

movies.js
```js
  onLoad: function (options) {
    wx.request({
      url: 'http://t.yushu.im/v2/movie/top250',
      method: 'GET', 
      header: {
        "Content-Type": "json"
      },
      success: function (res) {
        console.log(res.data)
      }
    })
  },

```

## 获取正在热映、即将上映和Top250的数据

数据接口： http://t.yushu.im/v2/movie/top250

movies.js
```js
var app = getApp();
Page({

  /**
   * 页面的初始数据
   */
  data: {
    
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
    var inTheatersUrl = app.globalData.doubanBase +
      "/v2/movie/in_theaters" + "?start=0&count=3";
    var comingSoonUrl = app.globalData.doubanBase +
      "/v2/movie/coming_soon" + "?start=0&count=3";
    var top250Url = app.globalData.doubanBase +
      "/v2/movie/top250" + "?start=0&count=3";
    
    this.getMovieListData(inTheatersUrl);

  },

  getMovieListData: function(url) {
    wx.request({
      url: url,
      method: 'GET',
      header: {
        "Content-Type": "json"
      },
      success: function (res) {
        console.log(res.data)
      },
      fail: function() {

      }
    })
  },
  ...
})
```

## 电影页面数据绑定（上）

movies.wxml
```xml
<import src="movie-list/movie-list-template.wxml" />

<view class="container">
    <view class="movies-template">
    <template is="movieListTemplate" data="{{...inTheaters}}" />
  </view>
  <view class="movies-template">
    <template is="movieListTemplate" data="{{...comingSoon}}" />
  </view>
  <view class="movies-template">
    <template is="movieListTemplate" data="{{...top250}}"/>
  </view>
</view>

```

movies.js
```js
var app = getApp();
Page({

  /**
   * 页面的初始数据
   */
  data: {
    inTheaters: {},
    comingSoon: {},
    top250: {},
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
    var inTheatersUrl = app.globalData.doubanBase +
      "/v2/movie/in_theaters" + "?start=0&count=3";
    var comingSoonUrl = app.globalData.doubanBase +
      "/v2/movie/coming_soon" + "?start=0&count=3";
    var top250Url = app.globalData.doubanBase +
      "/v2/movie/top250" + "?start=0&count=3";
    
    this.getMovieListData(inTheatersUrl, "inTheaters", "正在热映");
    this.getMovieListData(comingSoonUrl, "comingSoon", "即将上映");
    this.getMovieListData(top250Url, "top250", "豆瓣Top250");

  },

  getMovieListData: function (url, settedKey, categoryTitle) {
    var that = this;
    wx.request({
      url: url,
      method: 'GET',
      header: {
        "Content-Type": "json"
      },
      success: function (res) {
        console.log(res.data);
        that.processDoubanData(res.data, settedKey, categoryTitle)
      },
      fail: function(error) {
        console.log(error)
      }
    })
  },

  processDoubanData: function (moviesDouban, settedKey, categoryTitle) {
    var movies = [];
    for (var idx in moviesDouban.subjects) {
      var subject = moviesDouban.subjects[idx];
      var title = subject.title;
      if (title.length >= 6) {
        title = title.substring(0, 6) + "...";
      }

      var temp = {
        title: title,
        average: subject.rating.average,
        coverageUrl: subject.images.large,
        movieId: subject.id
      };
      movies.push(temp);
    }

    var readyData = {};
    readyData[settedKey] = {
      categoryTitle: categoryTitle,
      movies: movies
    }
    this.setData(readyData);
  },
})
```

movie-list-template.wxml
```xml
<import src="../movie/movie-template.wxml" />

<template name="movieListTemplate">
  <view class="movie-list-container">
    <view class="inner-container">

      <view class="movie-head">
        <text class="slogan">{{categoryTitle}}</text>
        <view class="more">
          <text class="more-text">更多</text>
          <image class="more-img" src="/images/icon/arrow-right.png"></image>
        </view>
      </view>

      <view class="movies-container">
        <block wx:for="{{movies}}" wx:for-item="movie" wx:key="unique">
          <template is="movieTemplate" data="{{...movie}}"></template>
        </block>
        
        <!-- <template is="movieTemplate"></template>
        <template is="movieTemplate"></template> -->
      </view>

    </view>
  </view>
</template>
```

movie-template.wxml
```xml
<import src="../stars/stars-template.wxml" />
<template name="movieTemplate">
  <view class="movie-container">
    <image class="movie-img" src="{{coverageUrl}}"></image>
    <text class="movie-title">{{title}}</text>
    <template is="starsTemplate" data="{{average}}"></template>
  </view>
</template>

```

stars-template.wxml
```xml
<template name="starsTemplate">
  <view class="stars-container">
    <view class="stars">
      <image src="/images/icon/star.png"></image>
      <image src="/images/icon/star.png"></image>
      <image src="/images/icon/star.png"></image>
      <image src="/images/icon/star.png"></image>
      <image src="/images/icon/star.png"></image>
    </view>
    <text class="star-score">{{average}}</text>
  </view>
</template>


```

## 星星评分组件的实现

utils/util.js
```js
module.exports = {
  convertToStarsArray: function(stars) {
    var num = stars.toString().substring(0, 1);
    var array = [];
    for (var i = 1; i <= 5; i++) {
      if (i <= num) {
        array.push(1);
      }
      else {
        array.push(0);
      }
    }
    return array;
  }
}

```

movie.js
```js
 // [1,1,1,1,1] [1,1,1,0,0]
 var temp = {
   stars: util.convertToStarsArray(subject.rating.stars),
   title: title,
   average: subject.rating.average,
   coverageUrl: subject.images.large,
   movieId: subject.id
 }
 movies.push(temp);

```


stars-template.wxml
```xml
<view class="stars">
   <block wx:for="{{stars}}" wx:for-item="i">
     <image wx:if="{{i}}" src="/images/icon/star.png"></image>
     <image wx:else src="/images/icon/none-star.png"></image>
   </block>
</view>

```

如果是半星时候的处理
[1,1,1,2,0]

```xml
<view class="stars">
   <block wx:for="{{stars}}" wx:for-item="i" wx:key="unique">
     <image wx:if="{{i == 1}}" src="/images/icon/star.png"></image>
     <image wx:elif="{{i == 2}}" src="/images/icon/star-half.png"></image>
     <image wx:else="{{i == 0}}" src="/images/icon/star-none.png"></image>
   </block>
</view>

```

# 第8章 更多电影及电影搜索页面的实现

## 更多电影页面的编写思路与电影类型获取

新增movies/more-movie等4个文件

小程序中页面之间的参数传递：

⓵ 全局变量

⓶ 缓存

⓷ URL

⓸ 事件


movie-list-temolate.wxml
```xml
<view catchtap="onMoreTap" class="more" data-categoryTitle="{{categoryTitle}}">
    <text class="more-text">更多</text>
    <image class="more-img" src="/images/icon/arrow-right.png"></image>
</view>
```

more-movie.js
```js
  onLoad: function (options) {
    var categoryTitle = options.categoryTitle;
    this.setData({
      categoryTitle: categoryTitle
    })
  },

```


movie.js
```js
  onMoreTap: function(event) {
    var categoryTitle = event.currentTarget.dataset.categorytitle;
    wx.navigateTo({
      url: 'more-movie/more-movie?categoryTitle=' + categoryTitle,
    })
  },

```

## 动态设置导航栏标题

https://developers.weixin.qq.com/miniprogram/dev/api/ui.html#wxsettopbartextobject

more-movie.js
```js
  onLoad: function (options) {
    var categoryTitle = options.categoryTitle;
    this.setData({
      categoryTitle: categoryTitle
    })
    wx.setNavigationBarTitle({
      title: categoryTitle,
    })
  },

```

## 更多电影页面加载数据



```js
// pages/movies/more-movie/more-movie.js
var util = require('../../../utils/util.js');
var app = getApp();
Page({
  data: {
    categoryTitle: ''
  },
  onLoad: function (options) {
    var categoryTitle = options.categoryTitle;
    this.setData({
      categoryTitle: categoryTitle
    });
    wx.setNavigationBarTitle({
      title: categoryTitle,
    });

    var dataUrl = "";
    switch (categoryTitle) {
      case "正在热映":
        dataUrl = app.globalData.doubanBase +
          "/v2/movie/in_theaters";
        break;
      case "即将上映":
        dataUrl = app.globalData.doubanBase +
          "/v2/movie/coming_soon";
        break;
      case "豆瓣Top250":
        dataUrl = app.globalData.doubanBase + "/v2/movie/top250";
        break;
    }

    this.setData({
      requestUrl: dataUrl
    });

    util.http(dataUrl, this.processDoubanData)
  },

  processDoubanData: function(data) {
    console.log(data)
  },
})
```

util.js
```js
function http(url, callBack) {
  wx.request({
    url: url,
    method: 'GET',
    header: {
      "Content-Type": "json"
    },
    success: function (res) {
      callBack(res.data);
    },
    fail: function (error) {
      console.log(error)
    }
  })
}


module.exports = {
  convertToStarsArray: convertToStarsArray,
  http: http
}

```

## 实现movie-grid template

more-movie/more-movie.wxml
```xml
<import src="../movie-grid/movie-grid-template.wxml" />
<template is="movieGridTemplate" data="{{movies}}" />
```

more-movie.js
```js
  data: {
    movies: [
      {
        stars: "",
        title: title,
        average: num,
        coverageUrl: "",
        movieId: num
      }
    ]
  },
```

moive-grid/movie-grid-template.wxml
```xml
<import src="../movie/movie-template.wxml" />
<template name="movieGridTemplate">
  <view class="grid-container">
    <block wx:for="{{movies}}" wx:for-item="movie">
      <view class="single-view-container">
        <template is="movieTemplate" data="{{...movie}}" />
      </view>
    </block>
  </view>
</template>
```

movie/movie-template.wxml
```xml
<import src="../stars/stars-template.wxml" />
<template name="movieTemplate">
    <view class="movie-container" catchtap="onMovieTap" data-movieId="{{movieId}}">
        <image class="movie-img" src="{{coverageUrl}}"></image>
        <text class="movie-title">{{title}}</text>
        <template is="starsTemplate" data="{{stars:stars, score: average}}" />
    </view>
</template>
```

## 实现上滑加载更多数据

https://developers.weixin.qq.com/miniprogram/dev/api/pulldown.html#onpulldownrefresh


https://zhuanlan.zhihu.com/p/24739728?refer=oldtimes

movie-grid-template.wxml
```xml
<template name="movieGridTemplate">
  <scroll-view scroll-y="true" scroll-x="false" bindscrolltolower="onScrollLower" class="grid-container">
    <block wx:for="{{movies}}" wx:for-item="movie" wx:key="unique">
      <view class="single-view-container">
        <template is="movieTemplate" data="{{...movie}}" />
      </view>
    </block>
  </scroll-view>
</template>
```

注意需要给scroll-view组件设置高度

more-movie.js
```js
Page({

  /**
   * 页面的初始数据
   */
  data: {
    categoryTitle: '',
    requestUrl: '',
    movies: [],
    totalCount: 0,
    isEmpty: true,
  },
 processDoubanData: function (moviesDouban) {
    // console.log(moviesDouban);
    var movies = [];

    for (var idx in moviesDouban.subjects) {
      var subject = moviesDouban.subjects[idx];
      var title = subject.title;
      if (title.length >= 6) {
        title = title.substring(0, 6) + "...";
      }

      // [1,1,1,1,1] [1,1,1,0,0]
      var temp = {
        // stars: util.convertToStarsArray(subject.rating.stars),
        stars: util.convertToStarsArray(subject.rating.average),
        title: title,
        average: subject.rating.average,
        coverageUrl: subject.images.large,
        movieId: subject.id
      }
      movies.push(temp);
    }

    var totalMovies = {}

    //如果要绑定新加载的数据，那么需要同旧有的数据合并在一起
    if (!this.data.isEmpty) {
      totalMovies = this.data.movies.concat(movies);
    }
    else {
      totalMovies = movies;
      // this.data.isEmpty = false;
      this.setData({
        isEmpty: false
      })
    }
    this.setData({
      movies: totalMovies
    });

    this.data.totalCount += 20;
    wx.hideNavigationBarLoading();
    wx.stopPullDownRefresh();
  },

  onScrollLower: function (event) {
    var nextUrl = this.data.requestUrl +
      "?start=" + this.data.totalCount + "&count=20";
    util.http(nextUrl, this.processDoubanData)
    wx.showNavigationBarLoading()
  },

})
```

# 第9章 构建电影详情页面

## 电影搜索页面构建（上）

https://developers.weixin.qq.com/miniprogram/dev/component/input.html

movies.wxml
```xml
<import src="movie-list/movie-list-template.wxml" />
<import src="movie-grid/movie-grid-template.wxml" />

<view class="search">
  <icon type="search" size="13" color="405f80" class="search-img"></icon>
  <input type="text" placeholder='最近有啥好电影' placeholder-class='placeholder' bindfocus='onBindFocus' bindconfirm="onBindConfirm"></input>
  <image wx-if="{{searchPanelShow}}" src="/images/icon/xx.png" bindtap='onCancelTap' class="xx-img"></image>
</view>

<view class="container" wx-if="{{containerShow}}">
    <view class="movies-template">
    <template is="movieListTemplate" data="{{...inTheaters}}" />
  </view>
  <view class="movies-template">
    <template is="movieListTemplate" data="{{...comingSoon}}" />
  </view>
  <view class="movies-template">
    <template is="movieListTemplate" data="{{...top250}}"/>
  </view>
</view>

<view class="search-panel" wx-if="{{searchPanelShow}}">
  <template is="movieGridTemplate" data="{{...searchResult}}" />
</view>
```

movies.js
```js
var app = getApp();
var util = require('../../utils/util.js');
Page({

  /**
   * 页面的初始数据
   */
  data: {
    inTheaters: {},
    comingSoon: {},
    top250: {},
    containerShow: true,
    searchPanelShow: false,
    searchResult: {}
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
    var inTheatersUrl = app.globalData.doubanBase +
      "/v2/movie/in_theaters" + "?start=0&count=3";
    var comingSoonUrl = app.globalData.doubanBase +
      "/v2/movie/coming_soon" + "?start=0&count=3";
    var top250Url = app.globalData.doubanBase +
      "/v2/movie/top250" + "?start=0&count=3";
    
    this.getMovieListData(inTheatersUrl, "inTheaters", "正在热映");
    this.getMovieListData(comingSoonUrl, "comingSoon", "即将上映");
    this.getMovieListData(top250Url, "top250", "豆瓣Top250");

  },

  getMovieListData: function (url, settedKey, categoryTitle) {
    var that = this;
    wx.request({
      url: url,
      method: 'GET',
      header: {
        "Content-Type": "json"
      },
      success: function (res) {
        // console.log(res.data);
        that.processDoubanData(res.data, settedKey, categoryTitle)
      },
      fail: function(error) {
        console.log(error)
      }
    })
  },

  processDoubanData: function (moviesDouban, settedKey, categoryTitle) {
    var movies = [];

    for (var idx in moviesDouban.subjects) {
      var subject = moviesDouban.subjects[idx];
      var title = subject.title;
      if (title.length >= 6) {
        title = title.substring(0, 6) + "...";
      }

      // [1,1,1,1,1] [1,1,1,0,0]
      var temp = {
        // stars: util.convertToStarsArray(subject.rating.stars),
        stars: util.convertToStarsArray(subject.rating.average),
        title: title,
        average: subject.rating.average,
        coverageUrl: subject.images.large,
        movieId: subject.id
      }
      movies.push(temp);
    }

    var readyData = {};
    readyData[settedKey] = {
      categoryTitle: categoryTitle,
      movies: movies
    }
    this.setData(readyData);
  },

  onMoreTap: function(event) {
    var categoryTitle = event.currentTarget.dataset.categorytitle;
    wx.navigateTo({
      url: 'more-movie/more-movie?categoryTitle=' + categoryTitle,
    })
  },

  // 输入框聚焦时触发，调出搜索页面，隐藏原来的页面
  onBindFocus: function(event) {
    
    this.setData({
      searchPanelShow: true,
      containerShow: false
    })
  },
  // 确定搜索
  onBindConfirm: function(event) {

    var text = event.detail.value;
    var searchUrl = app.globalData.doubanBase + "/v2/movie/search?q=" + text;
    this.getMovieListData(searchUrl, "searchResult", "");
  },
  // 取消搜索
  onCancelTap: function() {
    this.setData({
      searchPanelShow: false,
      containerShow: true,
      searchResult: {}
    })
  },
  ...
})

```

## tabbar的图片路径不要使用绝对路径

app.json
```json
  "tabBar": {
    "list": [
      {
        "pagePath": "pages/movies/movies",
        "text": "电影",
        "iconPath": "images/tab/dianying.png",
        "selectedIconPath": "images/tab/dianying_hl.png"
      },
      {
        "pagePath": "pages/posts/post",
        "text": "阅读",
        "iconPath": "images/tab/yuedu.png",
        "selectedIconPath": "images/tab/yuedu_hl.png"
      }
    
    ],
    "borderStyle": "white"
  }

```

## 修复音乐播放完成后图标状态没有复位的bug

post-detail.js
```js
// 监听音乐播放完了，按钮恢复成未播放状态
wx.onBackgroundAudioStop(function () {
 that.setData({
   isPlayingMusic: false
 })
 app.globalData.g_isPlayingMusic = false;
 // app.globalData.g_currentMusicPostId = null;
});

```

## 编写电影详情页面

## 图片的缩放与裁剪

https://developers.weixin.qq.com/miniprogram/dev/component/image.html

```html
<image src="" mode="" />
```

mode 有 13 种模式，其中 4 种是缩放模式，9 种是裁剪模式。

## 新版本更新后的补充章节

## 编写电影详情页面骨架


# 第10章 Form表单类组件与Map地图组件

openlayers

# 第11章 扩展内容ES6在小程序中的使用与微信小程序后台账号配置

## 小程序常见问题（非常重要）

## 小程序中的ES6 Class

# 第12章 0.15.152900 版本重要API、功能讲解

## 新版本重要特性总览

- 支持绝大多数ES6 API

- 开放蓝牙、卡券收获地址等接口能力

- 新增“场景值”这个概念

- 若干原有接口的丰富


## 选择用户收货地址API

https://developers.weixin.qq.com/miniprogram/dev/api/address.html#wxchooseaddressobject

## 对login、getUserInfo等接口的改动与理解

wx.login

- 不需要授权，静默登陆
- 登陆状态有时效性
- 多久失效由微信服务器决定

wx.checkSession 可查看是否失效


wx.getUserInfo

- 获取用户信息（明文信息，加密信息） 
- 没更新前，无论用户是否登陆，都可以获取加密信息


## 用户设置界面与动态分享详解

wx.openSetting

## 场景值获取方式与应用举例

https://developers.weixin.qq.com/miniprogram/dev/framework/app-service/scene.html

